@model Suendenbock_App.Controllers.BattleViewModel
@{
    ViewData["Title"] = "Kampf";
}

@section Styles {
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=MedievalSharp&display=swap" rel="stylesheet" />

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <!-- Battle CSS -->
    <link rel="stylesheet" href="~/css/spielmodus-battle.css" />
}

<div class="min-h-screen flex flex-col items-center p-4 md:p-8 bg-[#0a0a0a] text-gray-100 overflow-x-hidden relative font-['Cinzel']" id="battleContainer">
    <!-- Background Effect -->
    <div class="fixed inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-red-900/10 via-black to-black opacity-90 pointer-events-none"></div>

    <main class="relative z-10 w-full max-w-6xl flex flex-col items-center">

        <!-- ===== BATTLE GRID SCREEN ===== -->
        <section class="w-full space-y-6 animate-in fade-in duration-700" id="battleGridScreen">
            <!-- Header -->
            <header class="text-center mb-6 bg-black/40 border border-amber-500/20 rounded-lg p-6 shadow-[0_0_20px_rgba(245,158,11,0.2)]">
                <h1 class="text-5xl font-medieval uppercase tracking-[0.3em] text-amber-500 drop-shadow-[0_0_10px_rgba(245,158,11,0.5)] font-bold" id="roundTitle">
                    Runde <span id="currentRound" class="text-6xl">1</span>
                </h1>
                <p class="text-amber-300/80 italic mt-3 text-xl tracking-wide" id="turnIndicator">Initiative wird berechnet...</p>
                @if (!Model.IsGod)
                {
                    <div class="mt-4 bg-red-900/30 border border-red-500/50 rounded-lg px-6 py-3">
                        <p class="text-red-300 text-lg font-semibold">
                            <span class="text-2xl mr-2">üëÅÔ∏è</span>
                            Nur-Lese-Modus - Der Gott steuert den Kampf
                        </p>
                    </div>
                }
            </header>

            <!-- Biom Banner -->
            <div id="biomBanner" class="hidden border border-white/20 rounded-lg shadow-2xl overflow-hidden mb-4">
                <div class="p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">üåç</span>
                            <div>
                                <h3 class="text-white font-bold text-lg" id="activeBiomName">Aktuelles Biom</h3>
                                <button onclick="openBiomDescriptionPanel()" class="text-white/60 hover:text-white text-xs underline transition-colors">
                                    Beschreibung anzeigen
                                </button>
                            </div>
                        </div>
                        @if (Model.IsGod)
                        {
                            <button onclick="openEffectModal()" class="bg-green-500/20 hover:bg-green-500/30 text-green-300 border border-green-500/50 px-4 py-2 rounded text-sm font-semibold transition-colors">
                                Biom √§ndern
                            </button>
                        }
                    </div>
                </div>
            </div>

            <!-- Field Effects Banner -->
            <div id="fieldEffectsBanner" class="hidden bg-gradient-to-r border border-white/20 rounded-lg shadow-2xl overflow-hidden mb-6">
                <div class="p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-amber-300 font-bold text-lg flex items-center gap-2">
                            <span class="text-2xl">‚ö°</span>
                            Feldeffekte
                        </h3>
                        @if (Model.IsGod)
                        {
                            <button onclick="openEffectModal()" class="bg-amber-500/20 hover:bg-amber-500/30 text-amber-300 border border-amber-500/50 px-4 py-2 rounded text-sm font-semibold transition-colors">
                                + Effekt hinzuf√ºgen
                            </button>
                        }
                    </div>
                    <div id="activeFieldEffectsContainer" class="flex flex-wrap gap-2">
                        <!-- Active field effects will be rendered here via JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Defeated Enemies Button (links oben) -->
            <div class="flex justify-start mb-4">
                <button onclick="toggleDefeatedPanel()" class="bg-red-900/40 hover:bg-red-900/60 border-2 border-red-500/50 text-red-300 px-4 py-2 rounded-lg font-semibold transition-colors flex items-center gap-2">
                    <span class="material-symbols-outlined">skull</span>
                    <span>Gefallene Gegner</span>
                    <span id="defeatedCountBadge" class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full hidden">0</span>
                </button>
            </div>

            <!-- Participants Grid -->
            <div class="bg-white/5 border border-white/10 rounded-lg shadow-2xl overflow-hidden backdrop-blur-sm">
                <div class="p-4 space-y-4 overflow-y-auto custom-scrollbar" id="participantsContainer" style="max-height: calc(100vh - 180px);">
                    <!-- Participants werden via JS erstellt -->
                </div>
            </div>

            <!-- Action Buttons (nur f√ºr Gott) -->
            @if (Model.IsGod)
            {
                <div class="flex flex-col items-center pt-6 space-y-4">
                    <button
                        onclick="nextTurn()"
                        class="group relative bg-amber-500 text-black px-24 py-6 font-display font-bold uppercase tracking-[0.4em] text-2xl shadow-[0_0_30px_rgba(245,158,11,0.4)] hover:shadow-[0_0_40px_rgba(245,158,11,0.6)] hover:scale-105 transition-all active:scale-95 rounded-lg border-2 border-amber-600">
                        <div class="absolute inset-0 bg-gradient-to-b from-white/20 to-transparent rounded-lg pointer-events-none"></div>
                        <span>N√§chster Zug</span>
                    </button>
                    <button
                        onclick="endBattle()"
                        class="text-base text-amber-500/60 uppercase tracking-[0.3em] font-bold hover:text-amber-500 transition-colors">
                        Gefecht beenden
                    </button>
                </div>
            }
        </section>

        <!-- ===== VICTORY/DEFEAT SCREEN ===== -->
        <section class="w-full hidden" id="resultScreen">
            <div class="text-center space-y-8 animate-in fade-in duration-700">
                <div class="result-icon text-9xl" id="resultIcon"></div>
                <h1 class="text-6xl font-display uppercase tracking-widest" id="resultTitle"></h1>
                <p class="text-2xl text-white/60 italic" id="resultMessage"></p>

                <div class="flex justify-center gap-4 pt-8">
                    <a href="/Spielmodus/Dashboard" class="bg-amber-500 text-black px-12 py-4 font-display font-bold uppercase tracking-widest text-lg rounded hover:scale-105 transition-all">
                        <span class="material-symbols-outlined inline-block mr-2">fireplace</span>
                        Zur√ºck zum Lager
                    </a>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- Effect Modal (Feldeffekte & Biome - nur f√ºr Gott) -->
@if (Model.IsGod)
{
    <div id="effectModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 border-2 border-amber-500/50 rounded-lg shadow-2xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-amber-300">Effekt ausw√§hlen</h3>
                <button onclick="closeEffectModal()" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>

            <!-- Tab Navigation -->
            <div class="flex gap-2 mb-4 border-b border-gray-700">
                <button onclick="switchEffectTab('fieldeffect')" id="tabFieldEffect" class="px-4 py-2 font-semibold transition-colors border-b-2 border-amber-500 text-amber-300">
                    ‚ö° Feldeffekte
                </button>
                <button onclick="switchEffectTab('biom')" id="tabBiom" class="px-4 py-2 font-semibold transition-colors border-b-2 border-transparent text-gray-400 hover:text-white">
                    üåç Biome
                </button>
            </div>

            <!-- Field Effect Tab -->
            <div id="fieldEffectTab" class="space-y-4">
                <div>
                    <label class="block text-amber-300 font-semibold mb-2">Feldeffekt w√§hlen</label>
                    <select id="fieldEffectSelect" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white">
                        <option value="">-- Bitte w√§hlen --</option>
                        @foreach (var effect in Model.AllFieldEffects)
                        {
                            <option value="@effect.Id" data-name="@effect.Name" data-schwere="@effect.Schwere" data-color="@effect.ColorCode" data-description="@effect.Beschreibung">
                                @effect.Name (@effect.LightCardName) - @effect.Schwere
                            </option>
                        }
                    </select>
                </div>

                <!-- Description Display -->
                <div id="fieldEffectDescription" class="hidden bg-gray-800/50 border border-gray-700 rounded p-3">
                    <p class="text-gray-300 text-sm italic" id="fieldEffectDescriptionText"></p>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 mt-6">
                    <button onclick="closeEffectModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 rounded font-semibold transition-colors">
                        Abbrechen
                    </button>
                    <button onclick="addFieldEffect()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-black py-2 rounded font-semibold transition-colors">
                        Aktivieren
                    </button>
                </div>
            </div>

            <!-- Biom Tab -->
            <div id="biomTab" class="space-y-4 hidden">
                <div>
                    <label class="block text-green-300 font-semibold mb-2">Biom w√§hlen</label>
                    <select id="biomSelect" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white">
                        <option value="">-- Bitte w√§hlen --</option>
                        @foreach (var biom in Model.AllBiomes)
                        {
                            <option value="@biom.Id" data-name="@biom.Name" data-color="@biom.ColorCode" data-description="@biom.Beschreibung">
                                @biom.Name (@biom.LightCardName)
                            </option>
                        }
                    </select>
                </div>

                <!-- Description Display -->
                <div id="biomDescription" class="hidden bg-gray-800/50 border border-gray-700 rounded p-3">
                    <p class="text-gray-300 text-sm italic" id="biomDescriptionText"></p>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 mt-6">
                    <button onclick="closeEffectModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 rounded font-semibold transition-colors">
                        Abbrechen
                    </button>
                    <button onclick="setBiom()" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded font-semibold transition-colors">
                        Biom setzen
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Field Effect Description Slide-in Panel (f√ºr alle sichtbar) -->
<div id="fieldEffectPanel" class="fixed top-0 right-0 h-full w-96 bg-gray-900 border-l-4 shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50">
    <div class="h-full flex flex-col">
        <!-- Header mit dynamischer Farbe -->
        <div id="panelHeader" class="p-6 border-b border-gray-700">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-3xl">‚ö°</span>
                        <h3 id="panelTitle" class="text-2xl font-bold text-amber-300">Feldeffekt</h3>
                    </div>
                    <div id="panelStrength" class="inline-block px-3 py-1 rounded-full text-sm font-semibold"></div>
                </div>
                <button onclick="closeFieldEffectPanel()" class="text-gray-400 hover:text-white text-4xl leading-none transition-colors ml-4">
                    &times;
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <div class="space-y-4">
                <div>
                    <h4 class="text-amber-300 font-semibold mb-2 uppercase tracking-wider text-sm">Beschreibung</h4>
                    <p id="panelDescription" class="text-gray-300 leading-relaxed text-base"></p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="p-6 border-t border-gray-700 bg-gray-800/50">
            <button onclick="closeFieldEffectPanel()" class="w-full bg-amber-500 hover:bg-amber-600 text-black font-bold py-3 rounded-lg transition-colors">
                Verstanden
            </button>
        </div>
    </div>
</div>

<!-- Overlay f√ºr Slide-in Panel -->
<div id="fieldEffectPanelOverlay" class="fixed inset-0 bg-black/60 z-40 hidden transition-opacity duration-300 opacity-0" onclick="closeFieldEffectPanel()"></div>

<!-- Defeated Enemies Slide-in Panel (links) -->
<div id="defeatedPanel" class="fixed top-0 left-0 h-full w-96 bg-gray-900 border-r-4 border-red-500/50 shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out z-50">
    <div class="h-full flex flex-col">
        <!-- Header -->
        <div class="p-6 border-b border-red-500/30 bg-gradient-to-r from-red-900/50 to-red-800/30">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="material-symbols-outlined text-red-400 text-3xl">skull</span>
                        <h3 class="text-2xl font-bold text-red-300">Gefallene Gegner</h3>
                    </div>
                    <p class="text-red-400/70 text-sm">Besiegte Monster und Feinde</p>
                </div>
                <button onclick="toggleDefeatedPanel()" class="text-gray-400 hover:text-white text-4xl leading-none transition-colors ml-4">
                    &times;
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <div id="defeatedListContainer" class="space-y-2">
                <!-- Defeated enemies will be rendered here via JavaScript -->
            </div>
        </div>

        <!-- Footer -->
        <div class="p-6 border-t border-red-500/30 bg-gray-800/50">
            <button onclick="toggleDefeatedPanel()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg transition-colors">
                Schlie√üen
            </button>
        </div>
    </div>
</div>

<!-- Overlay f√ºr Defeated Panel -->
<div id="defeatedPanelOverlay" class="fixed inset-0 bg-black/60 z-40 hidden transition-opacity duration-300 opacity-0" onclick="toggleDefeatedPanel()"></div>

<!-- Conditions Description Slide-in Panel (rechts) -->
<div id="conditionsPanel" class="fixed top-0 right-0 h-full w-96 bg-gray-900 border-l-4 shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50">
    <div class="h-full flex flex-col">
        <!-- Header -->
        <div class="p-6 border-b border-amber-500/30 bg-gradient-to-r from-amber-900/50 to-amber-800/30">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="material-symbols-outlined text-amber-400 text-3xl">psychology</span>
                        <h3 class="text-2xl font-bold text-amber-300">Zust√§nde</h3>
                    </div>
                    <p class="text-amber-400/70 text-sm">Alle verf√ºgbaren Status-Effekte</p>
                </div>
                <button onclick="toggleConditionsPanel()" class="text-gray-400 hover:text-white text-4xl leading-none transition-colors ml-4">
                    &times;
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <div id="conditionsListContainer" class="space-y-3">
                <!-- Conditions will be rendered here via JavaScript -->
            </div>
        </div>

        <!-- Footer -->
        <div class="p-6 border-t border-amber-500/30 bg-gray-800/50">
            <button onclick="toggleConditionsPanel()" class="w-full bg-amber-500 hover:bg-amber-600 text-black font-bold py-3 rounded-lg transition-colors">
                Schlie√üen
            </button>
        </div>
    </div>
</div>

<!-- Overlay f√ºr Conditions Panel -->
<div id="conditionsPanelOverlay" class="fixed inset-0 bg-black/60 z-40 hidden transition-opacity duration-300 opacity-0" onclick="toggleConditionsPanel()"></div>

<!-- Biom Description Slide-in Panel (rechts) -->
<div id="biomPanel" class="fixed top-0 right-0 h-full w-96 bg-gray-900 border-l-4 shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50">
    <div class="h-full flex flex-col">
        <!-- Header mit dynamischer Farbe -->
        <div id="biomPanelHeader" class="p-6 border-b">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-3xl">üåç</span>
                        <h3 id="biomPanelTitle" class="text-2xl font-bold text-white">Biom</h3>
                    </div>
                </div>
                <button onclick="closeBiomPanel()" class="text-gray-400 hover:text-white text-4xl leading-none transition-colors ml-4">
                    &times;
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <div class="space-y-4">
                <div>
                    <h4 class="text-white/80 font-semibold mb-2 uppercase tracking-wider text-sm">Beschreibung</h4>
                    <p id="biomPanelDescription" class="text-gray-300 leading-relaxed text-base"></p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="p-6 border-t border-gray-700 bg-gray-800/50">
            <button onclick="closeBiomPanel()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition-colors">
                Verstanden
            </button>
        </div>
    </div>
</div>

<!-- Overlay f√ºr Biom Panel -->
<div id="biomPanelOverlay" class="fixed inset-0 bg-black/60 z-40 hidden transition-opacity duration-300 opacity-0" onclick="closeBiomPanel()"></div>

@section Scripts {
    <!-- SignalR Client Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Model-Daten f√ºr JavaScript (falls direkt aufgerufen ohne CombatSetup)
        const BATTLE_MODEL_DATA = {
            characters: @Html.Raw(Json.Serialize(Model.Characters)),
            monsters: @Html.Raw(Json.Serialize(Model.Monsters)),
            allFieldEffects: @Html.Raw(Json.Serialize(Model.AllFieldEffects)),
            allBiomes: @Html.Raw(Json.Serialize(Model.AllBiomes))
        };

        // WICHTIG: Rollenbasierte Zugriffskontrolle
        const IS_GOTT = @Json.Serialize(Model.IsGod);
    </script>
    <script src="~/js/battle.js"></script>

    <style>
        /* Custom Tailwind Colors */
        :root {
            --color-crimson: 128 0 32;
            --color-secondary: 212 175 55;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(212, 175, 55, 0.5);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(212, 175, 55, 0.8);
        }

        /* Slide-in Panels */
        #fieldEffectPanel.panel-open {
            transform: translateX(0) !important;
        }

        #fieldEffectPanelOverlay.overlay-active {
            opacity: 1 !important;
        }

        #defeatedPanel.panel-open {
            transform: translateX(0) !important;
        }

        #defeatedPanelOverlay.overlay-active {
            opacity: 1 !important;
        }

        #conditionsPanel.panel-open {
            transform: translateX(0) !important;
        }

        #conditionsPanelOverlay.overlay-active {
            opacity: 1 !important;
        }

        #biomPanel.panel-open {
            transform: translateX(0) !important;
        }

        #biomPanelOverlay.overlay-active {
            opacity: 1 !important;
        }

        /* Animations */
        @@keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @@keyframes slide-in-from-top {
            from {
                opacity: 0;
                transform: translateY(-0.5rem);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fade-in 0.5s ease-out;
        }

        .slide-in-from-top-2 {
            animation: slide-in-from-top 0.3s ease-out;
        }

        /* Font Families */
        .font-medieval {
            font-family: 'MedievalSharp', cursive;
        }

        .font-display {
            font-family: 'Cinzel', serif;
        }
    </style>
}
