@model Suendenbock_App.Controllers.CombatSetupViewModel
@{
    ViewData["Title"] = "Combat Setup";
}

@section Styles {
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&family=MedievalSharp&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: "#C5A059",
                        secondary: "#6B5B95",
                        accent: "#8B4513",
                        "background-light": "#F9F5EB",
                        "panel-light": "#F2E8D5",
                        "text-main": "#4A3B2A",
                    },
                    fontFamily: {
                        display: ["MedievalSharp", "serif"],
                        body: ["Lato", "sans-serif"],
                        cinzel: ["Cinzel", "serif"],
                    },
                },
            },
        };
    </script>
    <style>
        body {
            background-color: #F9F5EB;
        }

        .bg-pattern {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234A3B2A%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 0.65em auto;
            appearance: none;
        }
    </style>
}

<div class="bg-background-light text-text-main font-body min-h-screen relative overflow-hidden transition-colors duration-300 flex items-center justify-center p-4">
    <div class="absolute inset-0 pointer-events-none opacity-[0.03]" style="background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');"></div>

    <div class="relative w-full max-w-5xl bg-panel-light border-2 border-primary rounded-xl shadow-2xl overflow-hidden transform transition-all animate-fade-in">
        <!-- Ornamental Corners -->
        <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-primary rounded-tl-lg pointer-events-none"></div>
        <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-primary rounded-tr-lg pointer-events-none"></div>
        <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-primary rounded-bl-lg pointer-events-none"></div>
        <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-primary rounded-br-lg pointer-events-none"></div>

        <!-- Header -->
        <div class="bg-gradient-to-b from-primary/20 to-transparent p-6 text-center border-b border-primary/20">
            <h2 class="text-3xl font-display text-text-main tracking-wide drop-shadow-sm">
                Combat Setup
            </h2>
            <div class="flex justify-center mt-2">
                <div class="h-1 w-24 bg-gradient-to-r from-transparent via-primary to-transparent"></div>
            </div>
        </div>

        <!-- Content -->
        <div class="p-8 max-h-[85vh] overflow-y-auto">
            <form id="combatSetupForm" class="space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                    <!-- LEFT COLUMN: Monster Selection -->
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-cinzel tracking-wider text-text-main/80 border-b border-primary/30 pb-2 flex-1">Monster auswählen</h3>
                            <button type="button"
                                    onclick="addMonsterDropdown()"
                                    class="flex items-center gap-1 px-3 py-1 bg-primary/20 hover:bg-primary/30 border border-primary/50 rounded text-xs font-cinzel transition-colors">
                                <span class="material-icons text-sm">add</span>
                                <span>Monster hinzufügen</span>
                            </button>
                        </div>

                        <div id="monsterContainer" class="space-y-4">
                            <!-- Dropdowns werden hier via JS eingefügt -->
                        </div>

                        <!-- Benutzerdefinierte Gegner -->
                        <div class="mt-4 pt-4 border-t border-primary/20">
                            <div class="flex items-center justify-between">
                                <h3 class="text-sm font-cinzel tracking-wider text-text-main/70">Benutzerdefinierte Gegner</h3>
                                <button type="button"
                                        onclick="addCustomEnemy()"
                                        class="flex items-center gap-1 px-3 py-1 bg-red-100 hover:bg-red-200 border border-red-400/50 rounded text-xs font-cinzel transition-colors text-red-700">
                                    <span class="material-icons text-sm">add</span>
                                    <span>Gegner hinzufügen</span>
                                </button>
                            </div>
                            <div id="customEnemyContainer" class="space-y-3 mt-2">
                                <!-- Wird via JS eingefügt -->
                            </div>
                        </div>

                        <!-- Zusätzliche Teilnehmer (Neutrale) -->
                        <div class="mt-4 pt-4 border-t border-primary/20">
                            <div class="flex items-center justify-between">
                                <h3 class="text-sm font-cinzel tracking-wider text-text-main/70">Zusätzliche Teilnehmer</h3>
                                <button type="button"
                                        onclick="addExtraParticipant()"
                                        class="flex items-center gap-1 px-3 py-1 bg-primary/20 hover:bg-primary/30 border border-primary/50 rounded text-xs font-cinzel transition-colors">
                                    <span class="material-icons text-sm">add</span>
                                    <span>Hinzufügen</span>
                                </button>
                            </div>
                            <div id="extraParticipantContainer" class="space-y-3 mt-2">
                                <!-- Wird via JS eingefügt -->
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: Character Selection -->
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-cinzel tracking-wider text-text-main/80 border-b border-primary/30 pb-2 flex-1">Charaktere auswählen</h3>
                            <div class="flex gap-2">
                                <button type="button"
                                        onclick="selectAllCharacters()"
                                        class="flex items-center gap-1 px-3 py-1 bg-primary/20 hover:bg-primary/30 border border-primary/50 rounded text-xs font-cinzel transition-colors">
                                    <span class="material-icons text-sm">done_all</span>
                                    <span>Alle auswählen</span>
                                </button>
                                <button type="button"
                                        onclick="deselectAllCharacters()"
                                        class="flex items-center gap-1 px-3 py-1 bg-red-100 hover:bg-red-200 border border-red-300 rounded text-xs font-cinzel transition-colors text-red-700">
                                    <span class="material-icons text-sm">clear</span>
                                    <span>Alle abwählen</span>
                                </button>
                            </div>
                        </div>

                        <div class="space-y-3">
                            @foreach (var character in Model.Characters)
                            {
                                <label class="flex items-center p-3 bg-[#E8DCC0]/70 border border-primary/30 rounded cursor-pointer hover:bg-primary/10 transition-colors">
                                    <input type="checkbox"
                                           name="selectedCharacters"
                                           value="@character.Id"
                                           class="character-checkbox w-5 h-5 text-primary border-2 border-text-main/50 rounded focus:ring-primary focus:ring-offset-0"
                                           onchange="validateForm()" />
                                    <div class="ml-3 flex-1">
                                        <div class="flex items-center gap-2">
                                            <span class="font-body font-semibold text-base text-text-main">@character.Name</span>
                                            @if (character.IsBegleiter)
                                            {
                                                <span class="px-2 py-0.5 bg-primary/20 border border-primary/40 rounded text-xs font-cinzel">Begleiter</span>
                                            }
                                            else
                                            {
                                                <span class="px-2 py-0.5 bg-secondary/20 border border-secondary/40 rounded text-xs font-cinzel">Spieler</span>
                                            }
                                        </div>
                                        <div class="flex items-center gap-3 mt-1 text-xs text-text-main/70">
                                            <span>@character.CurrentHealth / @character.MaxHealth HP</span>
                                            <div class="flex-1 h-1.5 bg-text-main/10 rounded-full overflow-hidden">
                                                <div class="h-full bg-primary transition-all"
                                                     style="width: @(character.MaxHealth > 0 ? (character.CurrentHealth * 100.0 / character.MaxHealth).ToString("F2", System.Globalization.CultureInfo.InvariantCulture) : "0")%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                            }
                        </div>
                    </div>
                </div>

                <!-- Footer Buttons -->
                <div class="flex items-center justify-between pt-6 border-t border-primary/20">
                    <a href="/Spielmodus/Dashboard"
                       class="text-text-main/70 hover:text-primary font-cinzel text-sm tracking-widest uppercase transition-colors flex items-center gap-2 py-2">
                        <span class="material-icons text-base">arrow_back</span>
                        Zurück zum Lager
                    </a>
                    <button type="button"
                            id="continueToInitiativeBtn"
                            onclick="proceedToInitiative()"
                            disabled
                            class="group relative py-3 px-8 bg-primary text-white border border-amber-600 transition-all duration-300 rounded shadow-md flex items-center justify-center gap-3 overflow-hidden disabled:bg-gray-400/70 disabled:border-gray-500 disabled:text-white/70 disabled:cursor-not-allowed">
                        <span class="material-icons text-xl">arrow_forward</span>
                        <span class="font-cinzel font-bold tracking-wide">Weiter zur Initiative</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ===== SCREEN 2: INITIATIVE EINGABE ===== -->
    <div class="relative w-full max-w-5xl bg-panel-light border-2 border-primary rounded-xl shadow-2xl overflow-hidden transform transition-all hidden" id="initiativeScreen">
        <!-- Ornamental Corners -->
        <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-primary rounded-tl-lg pointer-events-none"></div>
        <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-primary rounded-tr-lg pointer-events-none"></div>
        <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-primary rounded-bl-lg pointer-events-none"></div>
        <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-primary rounded-br-lg pointer-events-none"></div>

        <!-- Header -->
        <div class="bg-gradient-to-b from-primary/20 to-transparent p-6 text-center border-b border-primary/20">
            <span class="material-icons text-primary text-6xl mb-4">military_tech</span>
            <h2 class="text-3xl font-display text-text-main tracking-wide drop-shadow-sm uppercase">
                Initiative festlegen
            </h2>
            <p class="text-text-main/60 font-cinzel italic mt-2">Bestimme die Reihenfolge der Einheiten (0-99)</p>
            <div class="flex justify-center mt-2">
                <div class="h-1 w-24 bg-gradient-to-r from-transparent via-primary to-transparent"></div>
            </div>
        </div>

        <!-- Content -->
        <div class="p-8 max-h-[75vh] overflow-y-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="initiativeInputsContainer">
                <!-- Wird via JavaScript gefüllt -->
            </div>

            <!-- Footer Buttons -->
            <div class="flex items-center justify-between pt-6 mt-6 border-t border-primary/20">
                <button type="button"
                        onclick="backToSetup()"
                        class="text-text-main/70 hover:text-primary font-cinzel text-sm tracking-widest uppercase transition-colors flex items-center gap-2 py-2">
                    <span class="material-icons text-base">arrow_back</span>
                    Zurück zur Auswahl
                </button>
                <button type="button"
                        id="startBattleBtn"
                        onclick="startBattle()"
                        class="group relative py-3 px-8 bg-primary text-white border border-amber-600 transition-all duration-300 rounded shadow-md flex items-center justify-center gap-3 overflow-hidden hover:bg-primary/90">
                    <span class="material-icons text-xl">swords</span>
                    <span class="font-cinzel font-bold tracking-wide">Gefecht starten!</span>
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Model-Daten für JavaScript
        const COMBAT_DATA = {
            monsters: @Html.Raw(Json.Serialize(Model.Monsters)),
            characters: @Html.Raw(Json.Serialize(Model.Characters))
        };

        let monsterCounter = 0;
        let selectedMonsters = {}; // { monsterId: { health: X, pokus: Y } }
        let customEnemyCounter = 0;
        let customEnemies = {}; // { enemyId: { name, health } }
        let extraParticipantCounter = 0;
        let extraParticipants = {}; // { extraId: { name, health } }

        // ===== MONSTER DROPDOWN HINZUFÜGEN =====

        function addMonsterDropdown() {
            const container = document.getElementById('monsterContainer');
            if (!container) return;

            const dropdownId = `monster-${monsterCounter++}`;

            const dropdownHTML = `
                <div class="monster-dropdown-item animate-fade-in" data-dropdown-id="${dropdownId}">
                    <div class="flex items-center gap-2 mb-2">
                        <select class="monster-select flex-1 bg-[#E8DCC0] border border-primary/50 rounded px-3 py-2 text-text-main focus:ring-primary focus:border-primary focus:outline-none transition-shadow shadow-inner bg-pattern"
                                onchange="monsterSelected(this, '${dropdownId}')">
                            <option value="">-- Monster wählen --</option>
                            ${COMBAT_DATA.monsters.map(m => `<option value="${m.id}" data-lebenspunkte="${m.lebenspunkte}">${m.name} (${m.monstertypName})</option>`).join('')}
                        </select>
                        <button type="button"
                                onclick="removeMonsterDropdown('${dropdownId}')"
                                class="flex items-center justify-center w-9 h-9 bg-red-100 hover:bg-red-200 border border-red-300 rounded text-red-600 transition-colors">
                            <span class="material-icons text-sm">close</span>
                        </button>
                    </div>
                    <div class="monster-stats hidden pl-4 space-y-2 border-l-2 border-primary/30">
                        <div>
                            <label class="block text-xs font-cinzel tracking-wider text-text-main/70 mb-1">Lebenspunkte (HP)</label>
                            <input type="number"
                                   min="1"
                                   class="monster-health w-full bg-[#E8DCC0] border border-primary/50 rounded px-2 py-1.5 text-sm text-text-main focus:ring-primary focus:border-primary focus:outline-none"
                                   placeholder="z.B. 100"
                                   oninput="updateMonsterStats('${dropdownId}')" />
                        </div>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', dropdownHTML);
            validateForm();
        }

        // ===== MONSTER AUSGEWÄHLT =====

        function monsterSelected(selectElement, dropdownId) {
            const monsterId = selectElement.value;
            const statsDiv = selectElement.closest('.monster-dropdown-item').querySelector('.monster-stats');
            const healthInput = selectElement.closest('.monster-dropdown-item').querySelector('.monster-health');

            if (monsterId) {
                statsDiv.classList.remove('hidden');

                // Lebenspunkte automatisch aus der DB vorausfüllen
                const selectedOption = selectElement.options[selectElement.selectedIndex];
                const lebenspunkte = selectedOption.getAttribute('data-lebenspunkte');

                if (lebenspunkte && healthInput) {
                    healthInput.value = lebenspunkte;
                    // Trigger oninput event, um selectedMonsters zu aktualisieren
                    updateMonsterStats(dropdownId);
                }
            } else {
                statsDiv.classList.add('hidden');
                if (healthInput) {
                    healthInput.value = '';
                }
                delete selectedMonsters[dropdownId];
            }

            validateForm();
        }

        // ===== MONSTER STATS AKTUALISIEREN =====

        function updateMonsterStats(dropdownId) {
            const item = document.querySelector(`[data-dropdown-id="${dropdownId}"]`);
            const select = item.querySelector('.monster-select');
            const health = item.querySelector('.monster-health').value;

            const monsterId = select.value;

            if (monsterId && health) {
                selectedMonsters[dropdownId] = {
                    monsterId: parseInt(monsterId),
                    health: parseInt(health)
                };
            } else {
                delete selectedMonsters[dropdownId];
            }

            validateForm();
        }

        // ===== MONSTER ENTFERNEN =====

        function removeMonsterDropdown(dropdownId) {
            const item = document.querySelector(`[data-dropdown-id="${dropdownId}"]`);
            if (item) {
                item.remove();
                delete selectedMonsters[dropdownId];
                validateForm();
            }
        }

        // ===== BENUTZERDEFINIERTE GEGNER =====

        function addCustomEnemy() {
            const container = document.getElementById('customEnemyContainer');
            if (!container) return;

            const enemyId = `enemy-${customEnemyCounter++}`;

            const html = `
                <div class="custom-enemy-item animate-fade-in bg-red-50/30 border border-red-300/40 rounded p-2" data-enemy-id="${enemyId}">
                    <div class="flex items-center gap-2">
                        <input type="text"
                               class="enemy-name flex-1 bg-[#E8DCC0] border border-red-400/50 rounded px-3 py-2 text-text-main focus:ring-red-500 focus:border-red-500 focus:outline-none text-sm"
                               placeholder="Gegner-Name (z.B. Bandit)"
                               oninput="updateCustomEnemy('${enemyId}')">
                        <input type="number"
                               min="1"
                               class="enemy-health w-24 bg-[#E8DCC0] border border-red-400/50 rounded px-2 py-2 text-text-main focus:ring-red-500 focus:border-red-500 focus:outline-none text-sm text-center"
                               placeholder="HP"
                               oninput="updateCustomEnemy('${enemyId}')">
                        <button type="button"
                                onclick="removeCustomEnemy('${enemyId}')"
                                class="flex items-center justify-center w-9 h-9 bg-red-100 hover:bg-red-200 border border-red-300 rounded text-red-600 transition-colors">
                            <span class="material-icons text-sm">close</span>
                        </button>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', html);
            validateForm();
        }

        function updateCustomEnemy(enemyId) {
            const item = document.querySelector(`[data-enemy-id="${enemyId}"]`);
            const name = item.querySelector('.enemy-name').value.trim();
            const health = item.querySelector('.enemy-health').value;

            if (name && health) {
                customEnemies[enemyId] = {
                    name: name,
                    health: parseInt(health)
                };
            } else {
                delete customEnemies[enemyId];
            }

            validateForm();
        }

        function removeCustomEnemy(enemyId) {
            const item = document.querySelector(`[data-enemy-id="${enemyId}"]`);
            if (item) {
                item.remove();
                delete customEnemies[enemyId];
                validateForm();
            }
        }

        // ===== EXTRA TEILNEHMER =====

        function addExtraParticipant() {
            const container = document.getElementById('extraParticipantContainer');
            if (!container) return;

            const extraId = `extra-${extraParticipantCounter++}`;

            const html = `
                <div class="extra-participant-item animate-fade-in" data-extra-id="${extraId}">
                    <div class="flex items-center gap-2">
                        <input type="text"
                               class="extra-name flex-1 bg-[#E8DCC0] border border-primary/50 rounded px-3 py-2 text-text-main focus:ring-primary focus:border-primary focus:outline-none text-sm"
                               placeholder="Name"
                               oninput="updateExtraParticipant('${extraId}')">
                        <input type="number"
                               min="1"
                               class="extra-health w-24 bg-[#E8DCC0] border border-primary/50 rounded px-2 py-2 text-text-main focus:ring-primary focus:border-primary focus:outline-none text-sm text-center"
                               placeholder="HP"
                               oninput="updateExtraParticipant('${extraId}')">
                        <button type="button"
                                onclick="removeExtraParticipant('${extraId}')"
                                class="flex items-center justify-center w-9 h-9 bg-red-100 hover:bg-red-200 border border-red-300 rounded text-red-600 transition-colors">
                            <span class="material-icons text-sm">close</span>
                        </button>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', html);
            validateForm();
        }

        function updateExtraParticipant(extraId) {
            const item = document.querySelector(`[data-extra-id="${extraId}"]`);
            const name = item.querySelector('.extra-name').value.trim();
            const health = item.querySelector('.extra-health').value;

            if (name && health) {
                extraParticipants[extraId] = {
                    name: name,
                    health: parseInt(health)
                };
            } else {
                delete extraParticipants[extraId];
            }

            validateForm();
        }

        function removeExtraParticipant(extraId) {
            const item = document.querySelector(`[data-extra-id="${extraId}"]`);
            if (item) {
                item.remove();
                delete extraParticipants[extraId];
                validateForm();
            }
        }

        // ===== CHARACTER SELECTION =====

        function selectAllCharacters() {
            const checkboxes = document.querySelectorAll('.character-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = true;
            });
            validateForm();
        }

        function deselectAllCharacters() {
            const checkboxes = document.querySelectorAll('.character-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            validateForm();
        }

        // ===== VALIDATION =====

        function validateForm() {
            const hasMonsters = Object.keys(selectedMonsters).length > 0;
            const hasCustomEnemies = Object.keys(customEnemies).length > 0;
            const hasCharacters = document.querySelectorAll('.character-checkbox:checked').length > 0;

            const continueBtn = document.getElementById('continueToInitiativeBtn');
            if (continueBtn) {
                // Mindestens ein Gegner (Monster ODER Custom Enemy) UND mindestens ein Character
                continueBtn.disabled = !((hasMonsters || hasCustomEnemies) && hasCharacters);
            }
        }

        // ===== ZUR INITIATIVE-PHASE WECHSELN =====

        let initiatives = {};

        function proceedToInitiative() {
            // Setup-Screen verstecken
            document.getElementById('combatSetupForm').parentElement.parentElement.classList.add('hidden');

            // Initiative-Screen zeigen
            document.getElementById('initiativeScreen').classList.remove('hidden');

            // Initiative-Inputs erstellen
            buildInitiativeInputs();
        }

        function buildInitiativeInputs() {
            const container = document.getElementById('initiativeInputsContainer');
            if (!container) return;

            const selectedCharacterIds = Array.from(document.querySelectorAll('.character-checkbox:checked'))
                .map(cb => parseInt(cb.value));

            const participants = [];

            // Characters hinzufügen
            selectedCharacterIds.forEach(id => {
                const char = COMBAT_DATA.characters.find(c => c.id === id);
                if (char) {
                    participants.push({
                        id: `char-${id}`,
                        name: char.name,
                        type: 'character',
                        isBegleiter: char.isBegleiter
                    });
                }
            });

            // Monster hinzufügen
            Object.values(selectedMonsters).forEach((monster, index) => {
                const monsterData = COMBAT_DATA.monsters.find(m => m.id === monster.monsterId);
                if (monsterData) {
                    participants.push({
                        id: `monster-${index}`,
                        name: monsterData.name,
                        type: 'monster',
                        monsterId: monster.monsterId,
                        health: monster.health
                    });
                }
            });

            // Benutzerdefinierte Gegner hinzufügen
            Object.values(customEnemies).forEach((enemy, index) => {
                participants.push({
                    id: `customEnemy-${index}`,
                    name: enemy.name,
                    type: 'customEnemy',
                    health: enemy.health
                });
            });

            // Extra-Teilnehmer hinzufügen
            Object.values(extraParticipants).forEach((extra, index) => {
                participants.push({
                    id: `extra-${index}`,
                    name: extra.name,
                    type: 'extra',
                    health: extra.health
                });
            });

            // Inputs generieren
            container.innerHTML = participants.map(p => `
                <div class="bg-[#E8DCC0]/70 border border-primary/30 p-4 rounded hover:border-primary/40 transition-colors">
                    <div class="flex items-center gap-2 mb-2">
                        <label class="text-[10px] uppercase tracking-widest font-bold flex-1 ${
                            p.type === 'monster' || p.type === 'customEnemy' ? 'text-red-600' : p.type === 'extra' ? 'text-primary' : p.isBegleiter ? 'text-primary' : 'text-secondary'
                        }">
                            ${p.name}
                        </label>
                        ${p.type === 'character' ?
                            (p.isBegleiter ?
                                '<span class="px-2 py-0.5 bg-primary/20 border border-primary/40 rounded text-[8px] font-cinzel">Begleiter</span>' :
                                '<span class="px-2 py-0.5 bg-secondary/20 border border-secondary/40 rounded text-[8px] font-cinzel">Spieler</span>'
                            ) :
                            p.type === 'extra' ?
                            '<span class="px-2 py-0.5 bg-primary/20 border border-primary/40 rounded text-[8px] font-cinzel">Extra</span>' :
                            p.type === 'customEnemy' ?
                            '<span class="px-2 py-0.5 bg-red-600/20 border border-red-600/40 rounded text-[8px] font-cinzel">Gegner</span>' :
                            '<span class="px-2 py-0.5 bg-red-600/20 border border-red-600/40 rounded text-[8px] font-cinzel">Monster</span>'
                        }
                    </div>
                    <input
                        type="number"
                        min="0"
                        max="99"
                        placeholder="0-99"
                        data-participant-id="${p.id}"
                        oninput="updateInitiative('${p.id}', this.value)"
                        class="w-full bg-black/60 border border-white/10 rounded p-2 text-2xl text-center font-bold text-text-main outline-none focus:border-primary transition-all"
                    />
                </div>
            `).join('');

            // Initiatives-Objekt initialisieren
            participants.forEach(p => {
                initiatives[p.id] = null;
            });
        }

        function updateInitiative(participantId, value) {
            initiatives[participantId] = value ? parseInt(value) : null;
            console.log('Initiatives:', initiatives);
        }

        function backToSetup() {
            document.getElementById('initiativeScreen').classList.add('hidden');
            document.getElementById('combatSetupForm').parentElement.parentElement.classList.remove('hidden');
        }

        // ===== BATTLE STARTEN =====

        async function startBattle() {
            const selectedCharacterIds = Array.from(document.querySelectorAll('.character-checkbox:checked'))
                .map(cb => parseInt(cb.value));

            const setup = {
                monsters: Object.values(selectedMonsters),
                customEnemies: Object.values(customEnemies),
                characterIds: selectedCharacterIds,
                extraParticipants: Object.values(extraParticipants),
                initiatives: initiatives
            };

            console.log('Combat Setup mit Initiatives:', setup);

            // Battle State JSON erstellen (für DB)
            const battleStateJson = JSON.stringify(setup);

            try {
                // Combat Session via API erstellen
                const response = await fetch('/api/battle/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        actId: @Model.ActId,
                        battleStateJson: battleStateJson
                    })
                });

                if (!response.ok) {
                    throw new Error('Fehler beim Erstellen der Combat Session');
                }

                const result = await response.json();
                console.log('Combat Session erstellt:', result);

                // Setup + SessionId in LocalStorage speichern
                const battleData = {
                    ...setup,
                    sessionId: result.sessionId,
                    actId: result.actId
                };
                localStorage.setItem('battleSetup', JSON.stringify(battleData));

                // Weiterleitung zu Battle
                window.location.href = '/Spielmodus/Battle';
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Starten des Kampfes. Bitte versuche es erneut.');
            }
        }

        // ===== INIT: Seite startet ohne Dropdowns =====
        // User muss auf "Monster hinzufügen" klicken

        document.addEventListener('DOMContentLoaded', () => {
            // Initial validation
            validateForm();
        });
    </script>
}
