@model Suendenbock_App.Controllers.MapViewModel
@{
    ViewData["Title"] = "Weltkarte";
}

@section Styles {
    <link rel="stylesheet" href="~/css/spielmodus.css" />
    <link rel="stylesheet" href="~/css/spielmodus-map.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
}

<div class="spielmodus-map-container">

    <!-- Header -->
    <header class="map-header">
        <div class="map-header-content">
            <div>
                <h1>@(Model.CurrentMap?.IsWorldMap == true ? "Weltkarte" : Model.CurrentMap?.Name ?? "Weltkarte")</h1>
                <p class="subtitle">Die Pfade des Schicksals</p>
            </div>
        </div>

        @if (Model.CurrentAct != null)
        {
            <!-- Act-Info für alle -->
            <div class="act-info">
                <span class="act-info-label">Aktueller Act:</span>
                <span class="act-info-name">Act @Model.CurrentAct.ActNumber - @Model.CurrentAct.Name</span>
            </div>
        }
    </header>

    @if (Model.CurrentMap != null && !Model.CurrentMap.IsWorldMap && Model.CurrentMap.ParentMapId.HasValue)
    {
        <nav class="map-breadcrumb">
            <a href="/Spielmodus/Map?mapId=@Model.CurrentMap.ParentMapId" class="breadcrumb-item">
                <span class="material-symbols-outlined">public</span>
                <span>@(Model.CurrentMap.ParentMapName ?? "Weltkarte")</span>
            </a>
            <span class="breadcrumb-separator">
                <span class="material-symbols-outlined">chevron_right</span>
            </span>
            <span class="breadcrumb-item current">
                <span class="material-symbols-outlined">map</span>
                <span>@Model.CurrentMap.Name</span>
            </span>
        </nav>
    }

    @if (Model.IsGod)
    {
        <div class="act-selector-container">
            <label for="actSelector">Arbeite an Act:</label>
            <select id="actSelector" class="act-selector" onchange="switchWorkingAct(this.value)">
            </select>
            <span class="act-status-indicator" id="actStatusIndicator"></span>
        </div>
    }

    @if (Model.CurrentMap == null)
    {
        <div class="no-map">
            <span class="material-symbols-outlined">map</span>
            <p>Für diesen Act existiert noch keine Karte.</p>
            @if (Model.IsGod)
            {
                <small>Bitte erstelle eine Karte über die Admin-Oberfläche.</small>
            }
        </div>
    }
    else
    {
        <main class="map-main @(Model.IsGod ? "has-sidebar" : "")">

            @if (Model.IsGod)
            {
                <aside class="marker-tools">
                    <div class="tools-card">
                        <h3>Kartentasche</h3>
                        <p class="tools-label">Marker Typ wählen</p>

                        <div class="marker-types">
                            <button class="marker-type-btn active" data-type="quest" data-icon="priority_high">
                                <span class="material-symbols-outlined">priority_high</span>
                                <span>Quest</span>
                            </button>
                            <button class="marker-type-btn" data-type="info" data-icon="info">
                                <span class="material-symbols-outlined">info</span>
                                <span>Info</span>
                            </button>
                            <button class="marker-type-btn" data-type="danger" data-icon="skull">
                                <span class="material-symbols-outlined">skull</span>
                                <span>Gefahr</span>
                            </button>
                            <button class="marker-type-btn" data-type="settlement" data-icon="fort">
                                <span class="material-symbols-outlined">fort</span>
                                <span>Ort</span>
                            </button>
                        </div>

                        <div class="tools-hint">
                            <span class="material-symbols-outlined">touch_app</span>
                            <p>Auf die Karte klicken, um einen Marker zu setzen</p>
                        </div>
                    </div>
                </aside>
            }

            <!-- Karten-Container -->
            <div class="map-canvas-wrapper">
                <img src="@Model.CurrentMap.ImageUrl"
                     alt="@Model.CurrentMap.Name"
                     class="map-background-image"
                     id="mapImage"
                     data-no-zoom="true" />

                @if (Model.CurrentMap.IsWorldMap && Model.CurrentMap.Regions.Any())
                {
                    <svg class="map-regions-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
                        @foreach (var region in Model.CurrentMap.Regions)
                        {
                            var points = System.Text.Json.JsonSerializer.Deserialize<List<System.Text.Json.JsonElement>>(region.PolygonPoints);
                            var pointsString = string.Join(" ", points.Select(p => $"{p.GetProperty("x").GetString()},{p.GetProperty("y").GetString()}"));

                            <polygon class="clickable-region"
                                     points="@pointsString"
                                     data-region-id="@region.Id"
                                     data-region-name="@region.RegionName"
                                     data-linked-map-id="@region.LinkedMapId">
                                <title>@region.RegionName</title>
                            </polygon>
                        }
                    </svg>

                    <!-- Region Flags/Labels -->
                    <div class="region-flags-layer">
                        @foreach (var region in Model.CurrentMap.Regions)
                        {
                            var points = System.Text.Json.JsonSerializer.Deserialize<List<System.Text.Json.JsonElement>>(region.PolygonPoints);
                            // Berechne Zentrum des Polygons
                            var xCoords = points.Select(p => double.Parse(p.GetProperty("x").GetString())).ToList();
                            var yCoords = points.Select(p => double.Parse(p.GetProperty("y").GetString())).ToList();
                            var centerX = xCoords.Average();
                            var centerY = yCoords.Average();

                            <div class="region-flag"
                                 style="left: @(centerX.ToString(System.Globalization.CultureInfo.InvariantCulture))%; top: @(centerY.ToString(System.Globalization.CultureInfo.InvariantCulture))%;"
                                 data-region-id="@region.Id"
                                 data-linked-map-id="@region.LinkedMapId"
                                 onclick="navigateToRegion(@region.LinkedMapId)">
                                <div class="flag-icon">
                                    <span class="material-symbols-outlined">flag</span>
                                </div>
                                <div class="flag-label">@region.RegionName</div>
                            </div>
                        }
                    </div>
                }

                <div class="map-marker-layer"
                     id="mapCanvas"
                     data-map-id="@Model.CurrentMap.Id"
                     data-is-god="@Model.IsGod.ToString().ToLower()">
                    @foreach (var marker in Model.CurrentMap.Markers.Where(m => m.Type != "region"))
                    {
                        <div class="map-marker marker-@marker.Type"
                             data-marker-id="@marker.Id"
                             data-marker-type="@marker.Type"
                             data-linked-map-id="@(marker.LinkedMapId?.ToString() ?? "")"
                             style="left: @(marker.XPercent.ToString(System.Globalization.CultureInfo.InvariantCulture))%; top: @(marker.YPercent.ToString(System.Globalization.CultureInfo.InvariantCulture))%;">
                            <div class="marker-pin">
                                <span class="material-symbols-outlined">
                                    @switch (marker.Type)
                                    {
                                        case "quest":
                                            @:priority_high
                                            break;
                                        case "info":
                                            @:info
                                            break;
                                        case "danger":
                                            @:skull
                                            break;
                                        case "settlement":
                                            @:fort
                                            break;
                                        default:
                                            @:location_on
                                            break;
                                    }
                                </span>
                            </div>
                            <div class="marker-label">@marker.Label</div>
                        </div>
                    }
                </div>
            </div>
        </main>
    }

    <section class="map-back">
        <a href="/Spielmodus/Dashboard" class="back-btn">
            <span class="material-symbols-outlined">fireplace</span>
            <div>
                <span class="back-text">Zurück zum Lager</span>
                <span class="back-subtext">Die Schatten werden länger</span>
            </div>
        </a>
    </section>

    <footer class="map-footer">
        <p>Sündenbock 1618 - Kartografie der Vergessenen</p>
    </footer>
</div>

<div id="markerPopup" class="marker-popup" style="display: none;">
    <div class="popup-content">
        <div class="popup-header">
            <h4 id="popupTitle">Marker Details</h4>
            <button id="closePopup" class="popup-close">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <div class="popup-body" id="popupBody">
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const MAP_DATA = {
            mapId: @(Model.CurrentMap?.Id ?? 0),
            isGod: @Model.IsGod.ToString().ToLower(),
            markers: @Html.Raw(Json.Serialize(Model.CurrentMap?.Markers ?? new List<Suendenbock_App.Controllers.MarkerViewModel>())),
            activeQuests: @Html.Raw(Json.Serialize(Model.ActiveQuests)),
            focusMarkerId: @(Model.FocusMarkerId?.ToString() ?? "null"),
            childMaps: @Html.Raw(Json.Serialize(Model.CurrentMap?.ChildMaps ?? new List<Suendenbock_App.Controllers.ChildMapViewModel>()))
        };
    </script>
    <script src="~/js/map.js"></script>

    @if (Model.IsGod)
    {
        <script src="~/js/working-act-manager.js"></script>
    }
}
