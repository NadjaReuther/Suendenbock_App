@model Suendenbock_App.Controllers.QuestsViewModel
@{
    ViewData["Title"] = "Quest-Chronik";
}

@section Styles {
    <!-- Material Symbols Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <!-- Dein CSS -->
    <link rel="stylesheet" href="~/css/spielmodus.css" />
    <link rel="stylesheet" href="~/css/spielmodus-quests.css" />
}

<div class="spielmodus-quests-container">

    <!-- Header -->
    <div class="quests-header">
        <h1>Quest-Chronik</h1>

        <!-- Add Button (nur für Gott) -->
        @if (Model.IsGod)
        {
            <button id="addQuestBtn" class="add-quest-btn" title="Neue Quest anlegen">
                <span class="material-symbols-outlined">add</span>
            </button>
        }
    </div>

    <!-- Tab Navigation -->
    <div class="quest-tabs">
        <button class="quest-tab active" data-status="all">
            <span class="material-symbols-outlined">auto_stories</span>
            <span>Alle</span>
        </button>
        <button class="quest-tab" data-status="active">
            <span class="material-symbols-outlined">history_edu</span>
            <span>Aktuell</span>
        </button>
        <button class="quest-tab" data-status="completed">
            <span class="material-symbols-outlined">verified</span>
            <span>Abgeschlossen</span>
        </button>
        <button class="quest-tab" data-status="failed">
            <span class="material-symbols-outlined">heart_broken</span>
            <span>Gescheitert</span>
        </button>
    </div>

    <!-- Character Filter -->
    <div class="character-filter">
        <h3>Nach Held filtern:</h3>
        <div class="character-buttons">
            @foreach (var character in Model.Characters)
            {
                <button class="character-filter-btn" data-character="@character">
                    @character
                </button>
            }
        </div>
    </div>

    <!-- Quest List -->
    <div id="questList" class="quest-list">
        @foreach (var quest in Model.Quests)
        {
            <div class="quest-card @quest.Type @quest.Status @(!quest.IsAvailable ? "quest-unavailable" : "")"
                 data-quest-id="@quest.Id"
                 data-type="@quest.Type"
                 data-status="@quest.Status"
                 data-character="@(quest.CharacterName ?? "")"
                 data-available="@quest.IsAvailable.ToString().ToLower()">

                <!-- Quest Header (clickable) -->
                <div class="quest-card-header">
                    <div class="quest-card-left">
                        <!-- Chevron/Expand Arrow -->
                        <span class="quest-chevron material-symbols-outlined">
                            chevron_right
                        </span>

                        <!-- Status Icon -->
                        <span class="quest-status-icon material-symbols-outlined">
                            @if (quest.Status == "active")
                            {
                                @:history_edu
                            }
                            else if (quest.Status == "completed")
                            {
                                @:verified
                            }
                            else
                            {
                                @:heart_broken
                            }
                        </span>

                        <!-- Title (durchgestrichen wenn failed) -->
                        <h2 class="quest-title @(quest.Status == "failed" ? "strikethrough" : "")">
                            @quest.Title
                        </h2>
                    </div>

                    <div class="quest-card-right">
                        <span class="quest-type-badge">
                            @(quest.Type == "group" ? "Gruppenquest" : "Personal")
                        </span>
                    </div>
                </div>

                <!-- Quest Body (collapsible) -->
                <div class="quest-card-body">
                    @if (!quest.IsAvailable && Model.IsGod)
                    {
                        <div class="quest-unavailable-notice">
                            <span class="material-symbols-outlined">lock</span>
                            <span>Quest noch nicht verfügbar: Vorgänger-Quest muss erst abgeschlossen/abgebrochen werden</span>
                        </div>
                    }

                    <p class="quest-description">
                        @(string.IsNullOrEmpty(quest.Description) ? "Keine Beschreibung hinterlegt." : quest.Description)
                    </p>

                    <!-- Previous Quest Info -->
                    @if (quest.PreviousQuestId.HasValue && !string.IsNullOrEmpty(quest.PreviousQuestTitle))
                    {
                        <div class="quest-assigned" style="margin-bottom: 0.75rem;">
                            <span class="assigned-label">📜 Folgequest von:</span>
                            <span class="assigned-character" style="font-style: italic;">@quest.PreviousQuestTitle</span>
                        </div>
                    }

                    <!-- Assigned Characters -->
                    <div class="quest-assigned">
                        <span class="assigned-label">Zugeordnete Helden:</span>
                        @if (!string.IsNullOrEmpty(quest.CharacterName))
                        {
                            <span class="assigned-character">@quest.CharacterName</span>
                        }
                        else
                        {
                            <span class="assigned-all">Alle Gefährten der Gruppe</span>
                        }
                    </div>

                    <!-- Map Marker Link -->
                    @if (quest.MapMarkerId.HasValue)
                    {
                        <div class="quest-map-link" style="margin-top: 0.75rem;">
                            <a href="/Spielmodus/Map?focusMarkerId=@quest.MapMarkerId" class="map-link-btn" style="
                                display: inline-flex;
                                align-items: center;
                                gap: 0.5rem;
                                padding: 0.5rem 1rem;
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                text-decoration: none;
                                border-radius: 6px;
                                font-size: 0.9rem;
                                font-weight: 500;
                                transition: transform 0.2s, box-shadow 0.2s;
                                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'"
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)'">
                                <span class="material-symbols-outlined" style="font-size: 1.2rem;">map</span>
                                <span>Auf Karte anzeigen</span>
                            </a>
                        </div>
                    }


                    <!-- Status Change Buttons (nur für Gott) -->
                    @if (Model.IsGod)
                    {
                        <div class="quest-actions">
                            <span class="actions-label">Admin: Quest Status ändern</span>
                            <div class="status-buttons">
                                <button class="status-btn status-active @(quest.Status == "active" ? "current" : "")"
                                        data-quest-id="@quest.Id"
                                        data-new-status="active">
                                    <span class="material-symbols-outlined">history_edu</span>
                                    <span>Aktiv</span>
                                </button>
                                <button class="status-btn status-completed @(quest.Status == "completed" ? "current" : "")"
                                        data-quest-id="@quest.Id"
                                        data-new-status="completed">
                                    <span class="material-symbols-outlined">verified</span>
                                    <span>Erfolg</span>
                                </button>
                                <button class="status-btn status-failed @(quest.Status == "failed" ? "current" : "")"
                                        data-quest-id="@quest.Id"
                                        data-new-status="failed">
                                    <span class="material-symbols-outlined">heart_broken</span>
                                    <span>Gescheitert</span>
                                </button>
                            </div>
                        </div>
                        <div class="quest-actions">
                            <span class="actions-label">Admin: Quest bearbeiten oder löschen</span>
                            <div class="status-buttons">
                                <button class="status-btn status-completed"
                                        data-quest-id="@quest.Id">
                                    <span class="material-symbols-outlined">edit</span>
                                    <span>Quest bearbeiten</span>
                                </button>
                                <button class="status-btn status-failed"
                                        data-quest-id="@quest.Id">
                                    <span class="material-symbols-outlined">delete</span>
                                    <span>Quest löschen</span>
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Empty State -->
        <div id="emptyState" class="quest-empty" style="display: none;">
            <span class="material-symbols-outlined">history_edu</span>
            <p>Keine Quests in dieser Kategorie gefunden.</p>
        </div>
    </div>

    <!-- Back Button -->
    <div class="quests-back">
        <a href="/Spielmodus/Dashboard" class="back-btn">
            <span class="material-symbols-outlined">fireplace</span>
            <div>
                <span class="back-text">Zurück zum Lager</span>
                <span class="back-subtext">Die Chronik wird fortgesetzt</span>
            </div>
        </a>
    </div>
</div>

<!-- Add Quest Modal (nur für Gott) -->
@if (Model.IsGod)
{
    <div id="questModal" class="quest-modal" style="display: none;">
        <div class="modal-content-quest">
            <div class="modal-header-quest">
                <h3>Neue Quest anlegen</h3>
                <button id="closeModalBtn" class="close-modal-btn">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <form id="questForm" class="quest-form">
                <!-- Title -->
                <div class="form-group">
                    <label>Titel der Quest</label>
                    <input type="text" id="questTitle" name="title" required autofocus />
                </div>

                <!-- Description -->
                <div class="form-group">
                    <label>Beschreibung</label>
                    <textarea id="questDescription" name="description" rows="3"></textarea>
                </div>

                <!-- Type & Status -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Quest-Typ</label>
                        <select id="questType" name="type">
                            <option value="individual">Personengebunden</option>
                            <option value="group">Gruppenquest</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="questStatus" name="status">
                            <option value="active">Aktuell</option>
                            <option value="completed">Abgeschlossen</option>
                            <option value="failed">Gescheitert</option>
                        </select>
                    </div>
                </div>

                <!-- Character Assignment (only for individual quests) -->
                <div class="form-group" id="characterAssignmentGroup">
                    <label>Charakter zuweisen</label>
                    <select id="questCharacter" name="characterId">
                        <option value="">Bitte wählen...</option>
                        @foreach (var kvp in Model.CharactersForDropdown)
                        {
                            <option value="@kvp.Key">@kvp.Value</option>
                        }
                    </select>
                </div>

                <!-- Previous Quest (for quest chains) -->
                <div class="form-group">
                    <label>Vorgänger-Quest (optional)</label>
                    <select id="questPreviousQuest" name="previousQuestId">
                        <option value="">Keine (Erstquest)</option>
                        @foreach (var kvp in Model.AllQuestsForDropdown)
                        {
                            <option value="@kvp.Key">@kvp.Value</option>
                        }
                    </select>
                    <small style="display: block; margin-top: 0.25rem; color: #666;">
                        Wähle eine Vorgänger-Quest, um eine Questkette zu erstellen.
                    </small>
                </div>

                <!-- Previous Quest Requirement (shown when previous quest is selected) -->
                <div class="form-group" id="questRequirementGroup" style="display: none;">
                    <label>Wann soll diese Folgequest erscheinen?</label>
                    <select id="questPreviousQuestRequirement" name="previousQuestRequirement">
                        <option value="both">Bei Erfolg oder Abbruch der Vorgänger-Quest</option>
                        <option value="completed">Nur bei erfolgreichem Abschluss</option>
                        <option value="failed">Nur bei Abbruch/Fehlschlag</option>
                    </select>
                    <small style="display: block; margin-top: 0.25rem; color: #666;">
                        Die Quest und ihr Marker werden erst sichtbar, wenn die Bedingung erfüllt ist.
                    </small>
                </div>

                <!-- Quest Marker -->
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="questCreateMarker" name="createMarker" />
                        Questmarker auf der Karte setzen
                    </label>
                </div>

                <!-- Marker Set Button (shown when checkbox is checked) -->
                <div id="markerSetButtonGroup" style="display: none;">
                    <button type="button" id="setMarkerOnMapBtn" class="status-btn status-active" style="width: 100%; margin-bottom: 1rem;">
                        <span class="material-symbols-outlined">map</span>
                        <span id="markerBtnText">Zur Karte → Marker setzen</span>
                    </button>
                    <input type="hidden" id="questMarkerX" name="markerXPercent" />
                    <input type="hidden" id="questMarkerY" name="markerYPercent" />
                    <small style="display: block; margin-top: -0.5rem; margin-bottom: 1rem; color: #666;">
                        Klicke auf den Button, um zur Karte zu gelangen und dort den Marker zu setzen.
                    </small>
                </div>

                <!-- Submit -->
                <button type="submit" class="submit-btn">
                    In die Chronik aufnehmen
                </button>
            </form>
        </div>
    </div>
}

@section Scripts {
    <script src="~/js/quests.js"></script>
    <script>
        const initialFocusQuestId = @Html.Raw(Model.FocusQuestId != null ? $"\"{Model.FocusQuestId}\"" : "null");
    </script>
}