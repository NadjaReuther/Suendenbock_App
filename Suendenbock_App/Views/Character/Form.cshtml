@using Suendenbock_App.Models.Domain
@model Character
@{
    ViewData["Title"] = Model != null && Model.Id > 0 ? "Charakter bearbeiten" : "Charakter erstellen";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    // Vereinfachte Step-Logik
    int currentStep = 1;
    if (ViewBag.Step != null)
    {
        currentStep = (int)ViewBag.Step;
    }
    else if (Model != null)
    {
        currentStep = (int)Model.CompletionLevel;
    }
}

@section Styles {
    <link href="/css/character.css" rel="stylesheet" />
    <link href="/css/wysiwyg-editor.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Uncial+Antiqua&display=swap" rel="stylesheet">
}

<div class="steckbrief-background">
    <div class="steckbrief-container">
        <div class="steckbrief-title">@ViewData["Title"]</div>
        <!-- drei Schritt Navigation -->
        <div class="step-navigation">
            <div class="step-item @(currentStep >= 1 ? "active" : "") @(currentStep > 1 ? "completed" : "")">
                <div class="step-number">1</div>
                <div class="step-title">Basis-Informationen</div>
                <div class="step-connector"></div>
            </div>
            <div class="step-item @(currentStep >= 2 ? "active" : "") @(currentStep > 2 ? "completed" : "")">
                <div class="step-number">2</div>
                <div class="step-title">Persönliche Details</div>
                <div class="step-connector"></div>
            </div>
            <div class="step-item @(currentStep >= 3 ? "active" : "")">
                <div class="step-number">3</div>
                <div class="step-title">Zugehörigkeiten</div>
            </div>
        </div>

        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show mt-3">
                @TempData["Success"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show mt-3">
                @TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <!-- Schritt 1: Basis Informationen -->
        <div class="form-step @(currentStep == 1 ? "active" : "")" data-step="1">
            <form asp-controller="Character" asp-action="SaveStep1" method="post" enctype="multipart/form-data">
                @if (Model != null && Model.Id > 0)
                {
                    <input type="hidden" name="Id" value="@Model.Id" />
                }
                <div class="row mt-5">
                    <div class="col-md-6 text-center">
                        <div class="image-upload-container">
                            <div class="image-preview" id="character-drop-zone" onclick="document.getElementById('characterImageUpload').click()">
                                @if (!string.IsNullOrEmpty(Model?.ImagePath))
                                {
                                    <img src="@Model.ImagePath" alt="Charakterbild" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;" />
                                }
                                else
                                {
                                    <div class="image-placeholder">
                                        <span>👤</span>
                                        <div>Portrait<br><small>Klicken zum Hochladen</small></div>
                                    </div>
                                }
                                <div class="drop-zone-hint">📁 Datei hier ablegen</div>
                            </div>
                            <input type="file" id="characterImageUpload" name="characterImage" accept="image/jpeg,image/jpg,image/png" style="display: none;" onchange="previewImage(this, '#character-drop-zone')">
                            <button type="button" class="image-upload-btn" onclick="document.getElementById('characterImageUpload').click()">
                                📷 Bild wählen
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="row mb-3">
                            <input type="text" class="form-control" id="vorname" name="vorname"
                                    value="@(Model != null ? Model.Vorname : "")" required placeholder="Vorname *">
                        </div>
                        <div class="row mb-3">
                            <input type="text" class="form-control" id="nachname" name="nachname"
                                   value="@(Model != null ? Model.Nachname : "")" required placeholder="Nachname *">
                        </div>
                        <div class="row mb-3">
                            <input type="text" class="form-control" id="rufname" name="rufname"
                               value="@(Model != null ? Model.Rufname : "")" required placeholder="Rufname *">
                        </div>
                        @if(User.IsInRole("Gott"))
                        {
                            <div class="form-group">
                                <label for="userId">Spieler zuweisen (optional)</label>
                                <select class="form-control" id="userId" name="userId">
                                    <option value="">-- kein Spieler (NPC) --</option>
                                    @foreach(var player in ViewBag.Players)
                                    {
                                        <option value="@player.Id" selected="@(Model?.UserId == player.Id)">
                                            @player.Email
                                        </option>
                                    }
                                </select>
                                <small class="form-text text-muted">
                                    Wähle einen Spieler aus, der diesen Character bearbeiten darf
                                </small>
                            </div>
                        }
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="geschlecht" class="form-label">Geschlecht *</label>
                        <select class="form-select" id="geschlecht" name="geschlecht" required>
                            <option value="">Geschlecht auswählen...</option>
                            @if (Model != null && Model.Geschlecht == "männlich")
                            {
                                <option value="männlich" selected>männlich</option>
                            }
                            else
                            {
                                <option value="männlich">männlich</option>
                            }

                            @if (Model != null && Model.Geschlecht == "weiblich")
                            {
                                <option value="weiblich" selected>weiblich</option>
                            }
                            else
                            {
                                <option value="weiblich">weiblich</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="geburtsdatum" class="form-label">Geburtsdatum</label>
                        <input type="date" class="form-control" id="geburtsdatum" name="geburtsdatum" value="@(Model?.Geburtsdatum ?? "")" min="100-01-01" max="1619-12-31" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="vaterId" class="form-label">Vater</label>
                        <select class="form-select character-select-male" id="vaterId" name="vaterId">
                            @if (Model?.Vater != null)
                            {
                                <option value="@Model.Vater.Id" selected>@Model.Vater.Vorname @Model.Vater.Nachname</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="mutterId" class="form-label">Mutter</label>
                        <select class="form-select character-select-female" id="mutterId" name="mutterId">
                            @if (Model?.Mutter != null)
                            {
                                <option value="@Model.Mutter.Id" selected>@Model.Mutter.Vorname @Model.Mutter.Nachname</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="rasseId" class="form-label">Rasse *</label>
                        <select class="form-select" id="rasseId" name="rasseId" required>
                            <option value="">Rasse auswählen...</option>
                            @if(ViewBag.Rassen != null)
                            {
                                foreach (var rasse in ViewBag.Rassen)
                                {
                                    if(Model?.Rasse?.Name == rasse.Name)
                                    {
                                        <option value="@rasse.Id" selected>@rasse.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@rasse.Id">@rasse.Name</option>
                                    }
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="lebensstatusId" class="form-label">Lebensstatus *</label>
                        <select class="form-select" id="lebensstatusId" name="lebensstatusId" required>
                            <option value="">Lebensstatus auswählen...</option>
                            @if (ViewBag.Lebensstatus != null)
                            {
                                foreach(var status in ViewBag.Lebensstatus)
                                {
                                    if(Model?.Lebensstatus?.Name == status.Name)
                                    {
                                        <option value="@status.Id" selected>@status.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@status.Id">@status.Name</option>
                                    }
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="eindruckId" class="form-label">Eindruck *</label>
                        <select class="form-select" id="eindruckId" name="eindruckId" required>
                            <option value="">Eindruck auswählen...</option>
                            @if (ViewBag.Eindruecke != null)
                            {
                                foreach(var eindruck in ViewBag.Eindruecke)
                                {
                                    if(Model?.Eindruck?.Name == eindruck.Name)
                                    {
                                        <option value="@eindruck.Id" selected>@eindruck.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@eindruck.Id">@eindruck.Name</option>
                                    }
                                }
                            }
                        </select>
                    </div>
                </div>              
                <!-- NACHHER: Profan/Beschraenkt Checkboxen + 2 Magie-Dropdowns -->
                <div class="mb-3">
                    <label class="form-label">Magie-Status</label>
                    <div class="card p-3">
                        <!-- NACHHER - funktioniert -->
                        <div class="mb-3">
                            <label class="form-label">Magie-Status</label>
                            <div class="card p-3">
                               

                                <div class="form-check form-check-inline">
                                    <input class="form-check-input magic-status-checkbox"
                                           type="checkbox"
                                           id="profan"
                                           asp-for="Profan"
                                           data-excludes="beschraenkt">
                                    <label class="form-check-label" for="profan">Profan</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input magic-status-checkbox"
                                           type="checkbox"
                                           id="beschraenkt"
                                           asp-for="Beschraenkt"
                                           data-excludes="profan">
                                    <label class="form-check-label" for="beschraenkt">Beschränkt</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Erste Magie -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label>Obermagie 1</label>
                        <select class="form-select obermagie-select"
                                id="obermagie1"
                                data-target="1">
                            <option value="">Bitte wählen...</option>
                            @foreach (var om in ViewBag.Obermagien)
                            {
                                @if (ViewBag.SelectedObermagie1 == om.Id)
                                {
                                    <option value="@om.Id" selected>@om.Bezeichnung</option>
                                }
                                else
                                {
                                    <option value="@om.Id">@om.Bezeichnung</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>Magieklasse 1</label>
                        <select class="form-select magicclass-select"
                                id="magicclass1"
                                name="selectedMagicClasses"
                                data-target="1"
                                data-preselect="@(ViewBag.SelectedMagicClass1 ?? 0)">
                            <option value="">Erst Obermagie wählen</option>
                        </select>
                    </div>
                    <div class="col-md-4 specialization-container"
                         id="spec-container-1"
                         style="display:none;">
                        <label>Spezialisierung 1</label>
                        <select class="form-select"
                                name="selectedSpecializations[1]"
                                data-preselect="@(ViewBag.SelectedSpecialization1 ?? 0)">
                            <option value="">Keine</option>
                        </select>
                    </div>
                </div>

                <!-- Zweite Magie -->
                <div class="row">
                    <div class="col-md-4">
                        <label>Obermagie 2</label>
                        <select class="form-select obermagie-select"
                                id="obermagie2"
                                data-target="2">
                            <option value="">Bitte wählen...</option>
                            @foreach (var om in ViewBag.Obermagien)
                            {
                                @if (ViewBag.SelectedObermagie2 == om.Id)
                                {
                                    <option value="@om.Id" selected>@om.Bezeichnung</option>
                                }
                                else
                                {
                                    <option value="@om.Id">@om.Bezeichnung</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>Magieklasse 2</label>
                        <select class="form-select magicclass-select"
                                id="magicclass2"
                                name="selectedMagicClasses"
                                data-target="2"
                                data-preselect="@(ViewBag.SelectedMagicClass2 ?? 0)">
                            <option value="">Erst Obermagie wählen</option>
                        </select>
                    </div>
                    <div class="col-md-4 specialization-container"
                         id="spec-container-2"
                         style="display:none;">
                        <label>Spezialisierung 2</label>
                        <select class="form-select"
                                name="selectedSpecializations[2]"
                                data-preselect="@(ViewBag.SelectedSpecialization2 ?? 0)">
                            <option value="">Keine</option>
                        </select>
                    </div>
                </div>                
                <div class="text-center">
                    <button type="submit" class="btn-wachs">Gebilligt</button>
                </div>
            </form>
        </div>

        <!-- Schritt 2: Persönliche Details -->
        <div class="form-step @(currentStep == 2 ? "active" : "")" data-step="2">
            @if (Model != null && Model.Id > 0)
            {
                <form asp-controller="Character" asp-action="SaveStep2" method="post">
                    <input type="hidden" name="Id" value="@Model.Id" />

                    <h4 class="text-center mb-4" style="color: #6e4b1f;">🏰 Persönliche Details</h4>
                        
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="standId" class="form-label">Stand</label>
                            <select class="form-select" id="standId" name="standId">
                                <option value="">Stand auswählen...</option>
                                @if (ViewBag.Staende != null)
                                {
                                    foreach (var stand in ViewBag.Staende)
                                    {
                                        if (Model?.Details?.Stand == stand)
                                        {
                                            <option value="@stand.Id" selected>@stand.Name</option>
                                        }
                                        else
                                        {
                                            <option value="@stand.Id">@stand.Name</option>
                                        }
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="beruf" class="form-label">Beruf</label>
                            <input type="text" class="form-control" id="beruf" name="beruf"
                                   value="@(Model?.Details?.Beruf ?? "")" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="hausId" class="form-label">Haus</label>
                            <select class="form-select" id="hausId" name="hausId">
                                <option value="">Haus auswählen...</option>
                                @if (ViewBag.Haeuser != null)
                                {
                                    foreach (var haus in ViewBag.Haeuser)
                                    {
                                        if (Model?.Details?.Haus?.Name == haus.Name)
                                        {
                                            <option value="@haus.Id" selected>@haus.Name</option>
                                        }
                                        else
                                        {
                                            <option value="@haus.Id">@haus.Name</option>
                                        }
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="herkunftslandId" class="form-label">Herkunftsland</label>
                            <select class="form-select" id="herkunftslandId" name="herkunftslandId">
                                <option value="">Herkunftsland wählen...</option>
                                @if (ViewBag.Herkunftslaender != null)
                                {
                                    foreach (var herkunftsland in ViewBag.Herkunftslaender)
                                    {
                                        if (Model?.Details?.Herkunftsland?.Name == herkunftsland.Name)
                                        {
                                            <option value="@herkunftsland.Id" selected>@herkunftsland.Name</option>
                                        }
                                        else
                                        {
                                            <option value="@herkunftsland.Id">@herkunftsland.Name</option>
                                        }
                                    }
                                }
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6  mb-3">
                            <label for="blutgruppeId" class="form-label">Blutgruppe</label>
                            <select class="form-select" id="blutgruppeId" name="blutgruppeId">
                                <option value="">Blutgruppe wählen...</option>
                                @if(ViewBag.Blutgruppen != null)
                                {
                                    foreach(var blutgruppe in ViewBag.Blutgruppen)
                                    {
                                        if(Model?.Details?.Blutgruppe?.Name == blutgruppe.Name)
                                        {
                                            <option value="@blutgruppe.Id" selected>@blutgruppe.Name</option>
                                        }                                        
                                        else
                                        {
                                            <option value="@blutgruppe.Id">@blutgruppe.Name</option>
                                        }
                                    }                                    
                                }                     
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="bodyHeight" class="form-label">Körpergröße (cm)</label>
                            <input type="number" class="form-control" id="bodyHeight" name="bodyHeight" 
                                    value="@(Model?.Details?.BodyHeight ?? 0)" placeholder="z.B. 175" min="50" max="600" />         
                        </div>
                    </div>

                    <div class="description-container">
                        <div id="editor-wrapper">
                            <textarea class="form-control d-none" id="description" name="description" required>
                                @(Model?.Details?.Description ?? "")
                            </textarea>
                            <div id="wysiwyg-editor"></div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <a href="@Url.Action("Form", new { id = Model?.Id, step = 1 })" class="btn btn-secondary me-3">
                            ← Zurück zu Schritt 1
                        </a>
                        <button type="submit" class="btn-wachs">Gebilligt</button>
                    </div>
                </form>
            }
            else
            {
                <div class="alert alert-warning">
                    Bitte speichern Sie zuerst die Basis-Informationen, um mit den persönlichen Details fortzufahren.
                </div>
            }
            </div>

        <!-- Schritt 3: Zugehörigkeiten -->
        <div class="form-step @(currentStep == 3 ? "active" : "")" data-step="3">
            @if (Model != null && Model.Id > 0)
            {
                <form asp-controller="Character" asp-action="SaveStep3" method="post">
                    <input type="hidden" name="Id" value="@Model.Id" />
                
                    <h4 class="text-center mb-4" style="color: #6e4b1f;">⚔️ Zugehörigkeiten</h4>
                
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="guldId" class="form-label">Gilde</label>
                            <select class="form-select" id="guildId" name="guildId">
                                <option value="" disabled selected>Gilde auswählen...</option>
                                @if (ViewBag.Guilds != null)
                                {
                                    foreach (var guild in ViewBag.Guilds)
                                    {
                                        if(Model?.Affiliation?.Guild?.Name == guild.Name)
                                        {
                                            <option value="@guild.Id" selected>@guild.Name</option>
                                        }
                                        else
                                        {
                                            <option value="@guild.Id">@guild.Name</option>
                                        }
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="religionId" class="form-label">Religion</label>
                            <select class="form-select" id="religionId" name="religionId">
                                <option value="" disabled selected>Religion auswählen...</option>
                                @if (ViewBag.Religions != null)
                                {
                                    foreach (var religion in ViewBag.Religions)
                                    {
                                        if(Model?.Affiliation?.Religion?.Type == religion.Type)
                                        {
                                            <option value="@religion.Id" selected>@religion.Type</option>
                                        }
                                        else
                                        {
                                            <option value="@religion.Id" selected>@religion.Type</option>  
                                        }
                                    }
                                }
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                        <label for="regimentsId" class="form-label">Regiment</label>
                        <select class="form-select" id="regimentsId" name="RegimentId">
                            <option value="">Regiment wählen...</option>
                            @if(ViewBag.Regiment != null)
                            {
                                foreach(var regiment in ViewBag.Regiment)
                                {
                                    if(Model?.Affiliation?.Regiment?.Name == regiment.Name)
                                    {
                                        <option value="@regiment.Id" selected>@regiment.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@regiment.Id">@regiment.Name</option>
                                    }
                                }
                            }                                                            
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="infanterierangId" class="form-label">Infanterierang</label>
                        <select class="form-select" id="infanterierangId" name="infanterierangId">
                            <option value="">Infanterierang wählen...</option>
                            @if(ViewBag.Infanterieraenge != null)
                            {
                                foreach(var infanterierang in ViewBag.Infanterieraenge)
                                {
                                    if(Model?.Affiliation?.Infanterierang?.Name == infanterierang.Name)
                                    {
                                        <option value="@infanterierang.Id" selected>@infanterierang.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@infanterierang.Id">@infanterierang.Name</option>
                                    }
                                }
                            }                     
                        </select>
                    </div>
                </div>
                    
                <div class="text-center mt-4">
                    <div class="alert alert-success mb-3">
                        <strong>🎉 Fast geschafft!</strong><br>
                        Überprüfe deine Angaben und schließe die Charaktererstellung ab.
                    </div>
                    <a href="@Url.Action("Form", new { id = Model?.Id, step = 2 })" class="btn btn-secondary me-3">
                        ← Zurück zu Schritt 2
                    </a>
                    <button type="submit" class="btn-wachs">Gebilligt</button>
                </div>
            </form>
        }
        else
        {
            <div class="alert alert-warning">
                Bitte speichern Sie zuerst die vorherigen Schritte, um fortzufahren.
            </div>
        }
          
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/imagePreview.js"></script>
    <script src="~/js/wysiwyg-editor.js"></script>
    <script src="~/js/entity-mentions.js"></script>
    <script>
        // Bild-Upload Drag & Drop aktivieren
        enableImageDragDrop('#character-drop-zone', 'characterImageUpload');

        $(document).ready(function() {
            const currentStep = @currentStep;

            // ========================================
            // WYSIWYG-Editor (nur Schritt 2)
            // ========================================
            if (currentStep === 2) {
                const wikiEditor = new WikiWYSIWYGEditor('#description');
                setTimeout(() => {
                    new EntityMentions('#description');
                }, 800);
            }

            // ========================================
            // Eltern-Auswahl (Select2)
            // ========================================
            $('.character-select-male').select2({
                ajax: {
                    url: '/api/Character/dropdown',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            search: params.term,
                            page: params.page || 1,
                            gender: 'männlich',
                            excludeId: @(Model?.Id ?? 0)
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.results.map(item => ({
                                id: item.id,
                                text: item.fullName
                            }))
                        };
                    },
                    cache: true
                },
                minimumInputLength: 1,
                placeholder: 'Vater suchen...',
                allowClear: true
            });

            $('.character-select-female').select2({
                ajax: {
                    url: '/api/Character/dropdown',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            search: params.term,
                            page: params.page || 1,
                            gender: 'weiblich',
                            excludeId: @(Model?.Id ?? 0)
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.results.map(item => ({
                                id: item.id,
                                text: item.fullName
                            }))
                        };
                    },
                    cache: true
                },
                minimumInputLength: 1,
                placeholder: 'Mutter suchen...',
                allowClear: true
            });

            // ========================================
            // MAGIE-SYSTEM (nur Schritt 1)
            // ========================================
            if (currentStep === 1) {
                // Daten aus ViewBag
                const allMagicClasses = @Html.Raw(Json.Serialize(ViewBag.MagicClassesJson ?? new List<object>()));
                const allSpecializations = @Html.Raw(Json.Serialize(ViewBag.SpecializationsJson ?? new List<object>()));
                const unbegabtId = 16;

                // ========================================
                // Profan/Beschränkt - gegenseitig ausschließend
                // ========================================
                $('.magic-status-checkbox').on('change', function() {
                    if ($(this).is(':checked')) {
                        const excludeId = $(this).data('excludes');
                        $('#' + excludeId).prop('checked', false);
                        console.log('✅ ' + $(this).attr('id') + ' aktiviert, ' + excludeId + ' deaktiviert');
                    }

                    // Specializations neu laden
                    $('.magicclass-select').trigger('change');
                });

                        // Obermagie-Auswahl
                $('.obermagie-select').on('change', function() {
                    const obermagieId = $(this).val();
                    const target = $(this).data('target');
                    const magicClassSelect = $(`#magicclass${target}`);
                    const specContainer = $(`#spec-container-${target}`);

                    // MagicClass-Dropdown zurücksetzen
                    magicClassSelect.empty();
                    magicClassSelect.append('<option value="">Bitte wählen...</option>');
                    specContainer.hide();

                    // ✨ NEU: Wenn Unbegabt in Slot 1, dann zweite Magie ausblenden
                    if (target == 1 && obermagieId == unbegabtId) {
                        // Zweite Magie-Reihe ausblenden
                        $('#obermagie2').closest('.row').hide();

                        // Zweite Magie zurücksetzen
                        $('#obermagie2').val('');
                        $('#magicclass2').empty().append('<option value="">Erst Obermagie wählen</option>').prop('disabled', true);
                        $('#spec-container-2').hide();

                        // Erste Magie deaktivieren
                        magicClassSelect.prop('disabled', true);
                        magicClassSelect.empty();
                        magicClassSelect.append('<option value="">Keine Magieklassen</option>');
                        return;
                    }

                    // ✨ NEU: Wenn Unbegabt NICHT gewählt, zweite Magie wieder einblenden
                    if (target == 1 && obermagieId != unbegabtId) {
                        $('#obermagie2').closest('.row').show();
                    }

                    // Wenn "Unbegabt" in Slot 2 ausgewählt
                    if (target == 2 && obermagieId == unbegabtId) {
                        magicClassSelect.prop('disabled', true);
                        magicClassSelect.empty();
                        magicClassSelect.append('<option value="">Keine Magieklassen</option>');
                        return;
                    }

                    // Wenn eine Obermagie gewählt wurde
                    if (obermagieId) {
                        // Passende MagicClasses filtern
                        const filteredClasses = allMagicClasses.filter(
                            mc => mc.obermagieId == obermagieId
                        );
                        // Dropdown befüllen
                        filteredClasses.forEach(mc => {
                            magicClassSelect.append(
                                `<option value="${mc.id}">${mc.bezeichnung}</option>`
                            );
                        });

                        magicClassSelect.prop('disabled', false);
                        console.log(`✅ ${filteredClasses.length} MagicClasses geladen`);
                    } else {
                        magicClassSelect.prop('disabled', true);
                        console.log('⏸️ Keine Obermagie gewählt');
                    }
                });

                // ========================================
                // MagicClass-Auswahl
                // ========================================
                $('.magicclass-select').on('change', function() {
                    const magicClassId = $(this).val();
                    const target = $(this).data('target');
                    const specContainer = $(`#spec-container-${target}`);
                    const specSelect = specContainer.find('select');
                    // Reset
                    specSelect.empty();
                    specSelect.append('<option value="">Keine</option>');
                    specContainer.hide();

                    // Prüfe ob Profan oder Beschränkt
                    const isProfan = $('#profan').is(':checked');
                    const isBeschraenkt = $('#beschraenkt').is(':checked');

                    if (isProfan || isBeschraenkt) {
                        return;
                    }

                    // Wenn MagicClass gewählt
                    if (magicClassId) {
                        // Passende Specializations filtern
                        const filteredSpecs = allSpecializations.filter(
                            s => s.magicClassId == magicClassId
                        );
                        if (filteredSpecs.length > 0) {
                            filteredSpecs.forEach(spec => {
                                specSelect.append(
                                    `<option value="${spec.id}">${spec.name}</option>`
                                );
                            });
                            specContainer.show();
                        }
                    }
                });
                // Slot 1 laden
                const preselectedObermagie1 = $('#obermagie1').val();
                if (preselectedObermagie1) {
                    $('#obermagie1').trigger('change');

                    // Warte kurz, dann MagicClass setzen
                    setTimeout(() => {
                        const preselectedMagicClass1 = $('#magicclass1').data('preselect');
                        if (preselectedMagicClass1 && preselectedMagicClass1 > 0) {
                            $('#magicclass1').val(preselectedMagicClass1);
                            $('#magicclass1').trigger('change');

                            // Warte kurz, dann Specialization setzen
                            setTimeout(() => {
                                const preselectedSpec1 = $('#spec-container-1 select').data('preselect');
                                if (preselectedSpec1 && preselectedSpec1 > 0) {
                                    $('#spec-container-1 select').val(preselectedSpec1);
                                }
                            }, 100);
                        }
                    }, 100);
                }

                // Slot 2 laden
                const preselectedObermagie2 = $('#obermagie2').val();
                if (preselectedObermagie2) {
                    $('#obermagie2').trigger('change');

                    setTimeout(() => {
                        const preselectedMagicClass2 = $('#magicclass2').data('preselect');
                        if (preselectedMagicClass2 && preselectedMagicClass2 > 0) {
                            $('#magicclass2').val(preselectedMagicClass2);
                            $('#magicclass2').trigger('change');

                            setTimeout(() => {
                                const preselectedSpec2 = $('#spec-container-2 select').data('preselect');
                                if (preselectedSpec2 && preselectedSpec2 > 0) {
                                    $('#spec-container-2 select').val(preselectedSpec2);
                                }
                            }, 100);
                        }
                    }, 100);
                }
            }
        });
    </script>
}