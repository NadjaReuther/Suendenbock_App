@using Suendenbock_App.Models.Domain
@model Character
@{
    ViewData["Title"] = Model != null && Model.Id > 0 ? "Charakter bearbeiten" : "Charakter erstellen";

    // Vereinfachte Step-Logik
    int currentStep = 1;
    if (ViewBag.Step != null)
    {
        currentStep = (int)ViewBag.Step;
    }
    else if (Model != null)
    {
        currentStep = (int)Model.CompletionLevel;
    }
}

@section Styles {
    <link href="/css/forms.css" rel="stylesheet" />
    <link href="/css/wysiwyg-editor.css" rel="stylesheet" />
}

<div class="steckbrief-background">
    <div class="steckbrief-container">
        <div class="steckbrief-title">@ViewData["Title"]</div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                @if (User.IsInRole("Gott"))
                {
                    <li class="breadcrumb-item"><a asp-controller="Admin" asp-action="Index">Admin</a></li>
                }
                else
                {
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                }
                <li class="breadcrumb-item active">@ViewData["Title"]</li>
            </ol>
        </nav>
        <!-- drei Schritt Navigation -->
        <div class="step-navigation">
            <div class="step-item @(currentStep >= 1 ? "active" : "") @(currentStep > 1 ? "completed" : "") @(Model?.Id > 0 ? "clickable" : "")" data-step="1" data-character-id="@(Model?.Id ?? 0)">
                <div class="step-number">1</div>
                <div class="step-title">Basis-Informationen</div>
                <div class="step-connector"></div>
            </div>
            <div class="step-item @(currentStep >= 2 ? "active" : "") @(currentStep > 2 ? "completed" : "") @(Model?.Id > 0 ? "clickable" : "")" data-step="2" data-character-id="@(Model?.Id ?? 0)">
                <div class="step-number">2</div>
                <div class="step-title">Persönliche Details</div>
                <div class="step-connector"></div>
            </div>
            <div class="step-item @(currentStep >= 3 ? "active" : "") @(Model?.Id > 0 ? "clickable" : "")" data-step="3" data-character-id="@(Model?.Id ?? 0)">
                <div class="step-number">3</div>
                <div class="step-title">Zugehörigkeiten</div>
            </div>
        </div>

        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show mt-3">
                @TempData["Success"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show mt-3">
                @TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <!-- Schritt 1: Basis Informationen -->
        <div class="form-step @(currentStep == 1 ? "active" : "")" data-step="1">
            <form asp-controller="Character" asp-action="SaveStep1" method="post" enctype="multipart/form-data">
                @if (Model != null && Model.Id > 0)
                {
                    <input type="hidden" name="Id" value="@Model.Id" />
                }
                <div class="row mt-5">
                    <div class="col-md-6 text-center">
                        <div class="image-upload-container">
                            <div class="image-preview" id="character-drop-zone" onclick="document.getElementById('characterImageUpload').click()">
                                @if (!string.IsNullOrEmpty(Model?.ImagePath))
                                {
                                    <img src="@Model.ImagePath" alt="Charakterbild" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;" />
                                }
                                else
                                {
                                    <div class="image-placeholder">
                                        <span>👤</span>
                                        <div>Portrait<br><small>Klicken zum Hochladen</small></div>
                                    </div>
                                }
                                <div class="drop-zone-hint">📁 Datei hier ablegen</div>
                            </div>
                            <input type="file" id="characterImageUpload" name="characterImage" accept="image/jpeg,image/jpg,image/png" style="display: none;" onchange="previewImage(this, '#character-drop-zone')">
                            <button type="button" class="image-upload-btn" onclick="document.getElementById('characterImageUpload').click()">
                                📷 Bild wählen
                            </button>
                        </div>
                        @if (User.IsInRole("Gott"))
                        {
                            <div class="form-group">
                                <label for="userId">Spieler zuweisen (optional)</label>
                                <select class="form-control" id="userId" asp-for="UserId">
                                    <option value="">-- kein Spieler (NPC) --</option>
                                    @foreach (var player in ViewBag.Players)
                                    {
                                        <option value="@player.Id" selected="@(Model?.UserId == player.Id)">
                                            @player.Email
                                        </option>
                                    }
                                </select>
                                <select class="form-control" id="userColor" name="userColor" asp-for="UserColor">
                                    <option value="">-- kein Farbcode --</option>
                                    @foreach (var color in ViewBag.Lightcards)
                                    {
                                        <option value="@color.Farbcode">@color.Farbcode</option>                                        
                                    }
                                </select>
                            </div>
                        }
                    </div>
                    <div class="col-md-6">
                        <div class="row mb-3">
                            <input type="text" class="form-control" id="vorname" asp-for="Vorname" placeholder="Vorname *" required>
                        </div>
                        <div class="row mb-3">
                            <input type="text" class="form-control" id="nachname" asp-for="Nachname" placeholder="Nachname *" required>
                        </div>
                        <div class="row mb-3">
                            <input type="text" class="form-control" id="rufname" asp-for="Rufname" placeholder="Rufname *" required>
                        </div>
                        <label for="partnerId" class="form-label">Ehepartner</label>
                        <select class="form-select character-select" id="partnerId" name="partnerId">
                            @if (Model?.Partner != null)
                            {
                                <option value="@Model.Partner.Id" selected>@Model.Partner.Vorname @Model.Partner.Nachname</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="Geschlecht" class="form-label"></label>
                        <select class="form-select" asp-for="Geschlecht" asp-items="ViewBag.Geschlechter" required>
                            <option value="">Geschlecht auswählen...</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label asp-for="Geburtsdatum" class="form-label"></label>
                        <input asp-for="Geburtsdatum" type="date" class="form-control" min="100-01-01" max="1619-12-31" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="vaterId" class="form-label">Vater</label>
                        <select class="form-select character-select-male" id="vaterId" name="vaterId">
                            @if (Model?.Vater != null)
                            {
                                <option value="@Model.Vater.Id" selected>@Model.Vater.Vorname @Model.Vater.Nachname</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="mutterId" class="form-label">Mutter</label>
                        <select class="form-select character-select-female" id="mutterId" name="mutterId">
                            @if (Model?.Mutter != null)
                            {
                                <option value="@Model.Mutter.Id" selected>@Model.Mutter.Vorname @Model.Mutter.Nachname</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label asp-for="RasseId" class="form-label"></label>
                        <select class="form-select" asp-for="RasseId" asp-items="ViewBag.Rassen" required>
                            <option value="">Rasse auswählen...</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label asp-for="LebensstatusId" class="form-label"></label>
                        <select class="form-select" asp-for="LebensstatusId" asp-items="ViewBag.Lebensstatus" required>
                            <option value="">Lebensstatus auswählen...</option>                            
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label asp-for="EindruckId" class="form-label"></label>
                        <select class="form-select" asp-for="EindruckId" asp-items="ViewBag.Eindruecke" required>
                            <option value="">Eindruck auswählen...</option>                            
                        </select>
                    </div>
                </div>

                <!-- HP und Pokus -->
                @if (User.IsInRole("Gott"))
                {
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label asp-for="CurrentHealth" class="form-label">Aktuelle LP</label>
                            <input asp-for="CurrentHealth" type="number" class="form-control" min="0" placeholder="z.B. 150" />
                        </div>
                        <div class="col-md-3 mb-3">
                            <label asp-for="BaseMaxHealth" class="form-label">Max LP</label>
                            <input asp-for="BaseMaxHealth" type="number" class="form-control" min="1" placeholder="z.B. 150" />
                        </div>
                        <div class="col-md-3 mb-3">
                            <label asp-for="CastedSpellsCount" class="form-label">Gewirkte Zauber</label>
                            <input asp-for="CastedSpellsCount" type="number" class="form-control" min="0" placeholder="z.B. 0" />
                        </div>
                        <div class="col-md-3 mb-3">
                            <label asp-for="BaseMaxPokus" class="form-label">Max Pokuspunkte</label>
                            <input asp-for="BaseMaxPokus" type="number" class="form-control" min="0" placeholder="z.B. 30" />
                        </div>
                    </div>
                }

                <!-- NACHHER: Profan/Beschraenkt Checkboxen + 2 Magie-Dropdowns -->
                <div class="mb-3">
                    <label class="form-label">Magie-Status</label>
                    <div class="card p-3">
                        <!-- NACHHER - funktioniert -->
                        <div class="mb-3">
                            <label class="form-label">Magie-Status</label>
                            <div class="card p-3">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input magic-status-checkbox"
                                           type="checkbox"
                                           id="profan"
                                           asp-for="Profan"
                                           data-excludes="beschraenkt">
                                    <label class="form-check-label" for="profan">Profan</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input magic-status-checkbox"
                                           type="checkbox"
                                           id="beschraenkt"
                                           asp-for="Beschraenkt"
                                           data-excludes="profan">
                                    <label class="form-check-label" for="beschraenkt">Beschränkt</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Erste Magie -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label>Obermagie 1</label>
                        <select class="form-select obermagie-select"
                                id="obermagie1"
                                data-target="1">
                            <option value="">Bitte wählen...</option>
                            @foreach (var om in ViewBag.Obermagien)
                            {
                                @if (ViewBag.SelectedObermagie1 == om.Id)
                                {
                                    <option value="@om.Id" selected>@om.Bezeichnung</option>
                                }
                                else
                                {
                                    <option value="@om.Id">@om.Bezeichnung</option>
                                }
                            }
                        </select>
                        <input type="hidden" id="selectedObermagie1-hidden" name="selectedObermagien" value="@(ViewBag.SelectedObermagie1 ?? "")" />                        
                    </div>
                    <div class="col-md-4">
                        <label>Magieklasse 1</label>
                        <select class="form-select magicclass-select"
                                id="magicclass1"
                                name="selectedMagicClasses"
                                data-target="1"
                                data-preselect="@(ViewBag.SelectedMagicClass1 ?? 0)">
                            <option value="">Erst Obermagie wählen</option>
                        </select>
                    </div>
                    <div class="col-md-4 specialization-container"
                         id="spec-container-1"
                         style="display:none;">
                        <label>Spezialisierung 1</label>
                        <select class="form-select"
                                name="selectedSpecializations[1]"
                                data-preselect="@(ViewBag.SelectedSpecialization1 ?? 0)">
                            <option value="">Keine</option>
                        </select>
                    </div>
                </div>

                <!-- Zweite Magie -->
                <div class="row">
                    <div class="col-md-4">
                        <label>Obermagie 2</label>
                        <select class="form-select obermagie-select"
                                id="obermagie2"
                                data-target="2">
                            <option value="">Bitte wählen...</option>
                            @foreach (var om in ViewBag.Obermagien)
                            {
                                @if (ViewBag.SelectedObermagie2 == om.Id)
                                {
                                    <option value="@om.Id" selected>@om.Bezeichnung</option>
                                }
                                else
                                {
                                    <option value="@om.Id">@om.Bezeichnung</option>
                                }
                            }
                        </select>
                        <input type="hidden" id="selectedObermagie2-hidden" name="selectedObermagien" value="@(ViewBag.SelectedObermagie2 ?? "")" />
                    </div>
                    <div class="col-md-4">
                        <label>Magieklasse 2</label>
                        <select class="form-select magicclass-select"
                                id="magicclass2"
                                name="selectedMagicClasses"
                                data-target="2"
                                data-preselect="@(ViewBag.SelectedMagicClass2 ?? 0)">
                            <option value="">Erst Obermagie wählen</option>
                        </select>
                    </div>
                    <div class="col-md-4 specialization-container"
                         id="spec-container-2"
                         style="display:none;">
                        <label>Spezialisierung 2</label>
                        <select class="form-select"
                                name="selectedSpecializations[2]"
                                data-preselect="@(ViewBag.SelectedSpecialization2 ?? 0)">
                            <option value="">Keine</option>
                        </select>
                    </div>
                </div>
                <div class="d-flex justify-content-center gap-3">
                    <button type="submit" class="btn-wachs" style="display: inline-block; margin: 0;">Gebilligt</button>
                    @if (User.IsInRole("Gott"))
                    {
                        <button type="submit" name="actionType" value="approved" class="btn-wachs" style="display: inline-block; margin: 0;">Geprüft</button>
                    }
                </div>
            </form>
        </div>

        <!-- Schritt 2: Persönliche Details -->
        <div class="form-step @(currentStep == 2 ? "active" : "")" data-step="2">
            @if (Model != null && Model.Id > 0)
            {
                <form asp-controller="Character" asp-action="SaveStep2" method="post">
                    <input type="hidden" name="Id" value="@Model.Id" />

                    <h4 class="text-center mb-4" style="color: #6e4b1f;">🏰 Persönliche Details</h4>
                        
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="StandId" class="form-label">Stand</label>
                            <select class="form-select" asp-for="Details.StandId" asp-items="ViewBag.Staende">
                                <option value="">Stand auswählen...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="Beruf" class="form-label">Beruf</label>
                            <input asp-for="Details.Beruf" type="text" class="form-control" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="HausId" class="form-label">Haus</label>
                            <select class="form-select" asp-for="Details.HausId" asp-items="ViewBag.Haeuser">
                                <option value="">Haus auswählen...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="HerkunftslandId" class="form-label">Herkunftsland</label>
                            <select class="form-select" asp-for="Details.HerkunftslandId" asp-items="ViewBag.Herkunftslaender">
                                <option value="">Herkunftsland wählen...</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6  mb-3">
                            <label for="BlutgruppeId" class="form-label">Blutgruppe</label>
                            <select class="form-select" asp-for="Details.BlutgruppeId" asp-items="ViewBag.Blutgruppen">
                                <option value="">Blutgruppe wählen...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="Details.BodyHeight" class="form-label">Körpergröße (cm)</label>
                            <input asp-for="Details.BodyHeight" type="number" class="form-control" placeholder="z.B. 175" min="50" max="600" />         
                        </div>
                    </div>
                    <div class="description-container">
                        <div id="editor-wrapper">
                            <textarea class="form-control d-none" id="description" name="Details.Description">
                                @(Model?.Details?.Description ?? "")
                            </textarea>
                            <div id="wysiwyg-editor"></div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-center gap-3 mt-4">
                        <button type="submit" class="btn-wachs" style="display: inline-block; margin: 0;">Gebilligt</button>
                        @if (User.IsInRole("Gott"))
                        {
                            <button type="submit" name="actionType" value="approved" class="btn-wachs" style="display: inline-block; margin: 0;">Geprüft</button>
                        }
                    </div>
                </form>
            }
            else
            {
                <div class="alert alert-warning">
                    Bitte speichern Sie zuerst die Basis-Informationen, um mit den persönlichen Details fortzufahren.
                </div>
            }
            </div>

        <!-- Schritt 3: Zugehörigkeiten -->
        <div class="form-step @(currentStep == 3 ? "active" : "")" data-step="3">
            @if (Model != null && Model.Id > 0)
            {
                <form asp-controller="Character" asp-action="SaveStep3" method="post">
                    <input type="hidden" name="Id" value="@Model.Id" />
                
                    <h4 class="text-center mb-4" style="color: #6e4b1f;">⚔️ Zugehörigkeiten</h4>
                
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="GuldId" class="form-label">Gilde</label>
                            <select class="form-select" asp-for="Affiliation.GuildId" asp-items="ViewBag.Guilds">
                                <option value="" disabled selected>Gilde auswählen...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="ReligionId" class="form-label">Religion</label>
                            <select class="form-select" asp-for="Affiliation.ReligionId" asp-items="ViewBag.Religions">
                                <option value="" disabled selected>Religion auswählen...</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                        <label for="RegimentsId" class="form-label">Regiment</label>
                        <select class="form-select" asp-for="Affiliation.RegimentId" asp-items="ViewBag.Regiment">
                            <option value="">Regiment wählen...</option>                 
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="InfanterierangId" class="form-label">Infanterierang</label>
                        <select class="form-select" asp-for="Affiliation.InfanterierangId" asp-items="ViewBag.Infanterieraenge">
                            <option value="">Infanterierang wählen...</option>
                        </select>
                    </div>
                </div>
                    
                <div class="mt-4">
                    <div class="alert alert-success mb-3 text-center">
                        <strong>🎉 Fast geschafft!</strong><br>
                        Überprüfe deine Angaben und schließe die Charaktererstellung ab.
                    </div>
                    <div class="d-flex justify-content-center gap-3">
                        <button type="submit" class="btn-wachs" style="display: inline-block; margin: 0;">Gebilligt</button>
                        @if (User.IsInRole("Gott"))
                        {
                            <button type="submit" name="actionType" value="approved" class="btn-wachs" style="display: inline-block; margin: 0;">Geprüft</button>
                        }
                    </div>
                </div>
            </form>
        }
        else
        {
            <div class="alert alert-warning">
                Bitte speichern Sie zuerst die vorherigen Schritte, um fortzufahren.
            </div>
        }
          
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/imagePreview.js"></script>
    <script src="~/js/wysiwyg-editor.js"></script>
    <script src="~/js/entity-mentions.js"></script>
    
    <script>
        // Bild-Upload Drag & Drop aktivieren
        enableImageDragDrop('#character-drop-zone', 'characterImageUpload');

        $(document).ready(function() {
            const currentStep = @currentStep;

            // Schritt-Navigation klickbar machen
            $('.step-item.clickable').click(function() {
                const step = $(this).data('step');
                const characterId = $(this).data('character-id');
                if (characterId > 0) {
                    window.location.href = '@Url.Action("Form", "Character")?id=' + characterId + '&step=' + step;
                }
            });

            // ========================================
            // WYSIWYG-Editor (nur Schritt 2)
            // ========================================
            if (currentStep === 2) {
                const wikiEditor = new WikiWYSIWYGEditor('#description', '#wysiwyg-editor');
                setTimeout(() => {
                    new EntityMentions('#description');
                }, 800);
            }

            // ========================================
            // Eltern-Auswahl (Select2)
            // ========================================

            // Vater - Auswahl (nur männliche Charaktere)
            $('.character-select-male').select2({
                ajax: {
                    url: '/api/Character/dropdown',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            search: params.term,
                            page: params.page || 1,
                            gender: 'männlich',
                            excludeId: @(Model?.Id ?? 0)
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.results.map(item => ({
                                id: item.id,
                                text: item.fullName
                            }))
                        };
                    },
                    cache: true
                },
                minimumInputLength: 1,
                placeholder: 'Vater suchen...',
                allowClear: true
            });
            // Mutter - Auswahl (nur weibliche Charaktere)
            $('.character-select-female').select2({
                ajax: {
                    url: '/api/Character/dropdown',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            search: params.term,
                            page: params.page || 1,
                            gender: 'weiblich',
                            excludeId: @(Model?.Id ?? 0)
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.results.map(item => ({
                                id: item.id,
                                text: item.fullName
                            }))
                        };
                    },
                    cache: true
                },
                minimumInputLength: 1,
                placeholder: 'Mutter suchen...',
                allowClear: true
            });
            // Ehepartner - Auswahl (unabhängig vom Geschlecht)
            $('.character-select').select2({
                ajax: {
                    url: '/api/Character/dropdown',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            search: params.term,
                            page: params.page || 1,
                            excludeId: @(Model?.Id ?? 0)
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.results.map(item => ({
                                id: item.id,
                                text: item.fullName
                            }))
                        };
                    },
                    cache: true
                },
                minimumInputLength: 1,
                placeholder: 'Ehepartner suchen...',
                allowClear: true
            });
            // ========================================
            // MAGIE-SYSTEM (nur Schritt 1)
            // ========================================
            if (currentStep === 1) {
                // Daten aus ViewBag
                const allMagicClasses = @Html.Raw(Json.Serialize(ViewBag.MagicClassesJson ?? new List<object>()));
                const allSpecializations = @Html.Raw(Json.Serialize(ViewBag.SpecializationsJson ?? new List<object>()));
                const unbegabtId = 16;

                // Profan/Beschränkt - Gegenseitiger Ausschluss
                $('.magic-status-checkbox').on('change', function() {
                    if ($(this).is(':checked')) {
                        const excludeId = $(this).data('excludes');
                        $('#' + excludeId).prop('checked', false);
                        console.log('✅ ' + $(this).attr('id') + ' aktiviert, ' + excludeId + ' deaktiviert');
                    }
                    $('.magicclass-select').trigger('change');
                });

                // Obermagie-Auswahl: Lädt passende MagicClasses
                $('.obermagie-select').on('change', function() {
                    const obermagieId = $(this).val();
                    const target = $(this).data('target');
                    const magicClassSelect = $(`#magicclass${target}`);
                    const specContainer = $(`#spec-container-${target}`);

                    // Hidden Input aktualisieren
                    $(`#selectedObermagie${target}-hidden`).val(obermagieId || '');
                    
                    // Dropdown zurücksetzen
                    magicClassSelect.empty();
                    magicClassSelect.append('<option value="">Bitte wählen...</option>');
                    specContainer.hide();

                    // Unbegabt in Slot 1: Zweite Magie ausblenden
                    if (target == 1 && obermagieId == unbegabtId) {
                        $('#obermagie2').closest('.row').hide();
                        $('#obermagie2').val('');
                        $('#magicclass2').empty().append('<option value="">Erst Obermagie wählen</option>').prop('disabled', true);
                        $('#spec-container-2').hide();
                        magicClassSelect.prop('disabled', true).empty().append('<option value="">Keine Magieklassen</option>');
                        return;
                    }

                    // Unbegabt NICHT gewählt: zweite Magie einblenden
                    if (target == 1 && obermagieId != unbegabtId) {
                        $('#obermagie2').closest('.row').show();
                    }

                    // Unbegabt in Slot 2: MagicClass deaktivieren
                    if (target == 2 && obermagieId == unbegabtId) {
                        magicClassSelect.prop('disabled', true).empty().append('<option value="">Keine Magieklassen</option>');
                        return;
                    }

                    // Normale Obermagie: MagicClasses laden
                    if (obermagieId) {
                        const filteredClasses = allMagicClasses.filter(mc => mc.obermagieId == obermagieId);                        
                        filteredClasses.forEach(mc => {
                            magicClassSelect.append(`<option value="${mc.id}">${mc.bezeichnung}</option>`);
                        });
                        magicClassSelect.prop('disabled', false);
                    } else {
                        magicClassSelect.prop('disabled', true);
                    }
                });

                // MagicClass-Auswahl: Lädt passende Spezialisierungen
                $('.magicclass-select').on('change', function() {
                    const magicClassId = $(this).val();
                    const target = $(this).data('target');
                    const specContainer = $(`#spec-container-${target}`);
                    const specSelect = specContainer.find('select');
                
                    // Spezialisierung zurücksetzen
                    specSelect.empty().append('<option value="">Keine</option>');
                    specContainer.hide();

                    // Profan/Beschränkt: Keine Spezialisierungen
                    const isProfan = $('#profan').is(':checked');
                    const isBeschraenkt = $('#beschraenkt').is(':checked');
                    if (isProfan || isBeschraenkt) return;

                    // Spezialisierungen laden und anzeigen
                    if (magicClassId) {                        
                        const filteredSpecs = allSpecializations.filter(s => s.magicClassId == magicClassId);
                        if (filteredSpecs.length > 0) {
                            filteredSpecs.forEach(spec => {
                                specSelect.append(
                                    `<option value="${spec.id}">${spec.name}</option>`
                                );
                            });
                            specContainer.show();
                        }
                    }
                });

                // Vorauswahl laden: Slot 1
                const preselectedObermagie1 = $('#obermagie1').val();
                if (preselectedObermagie1) {
                    $('#obermagie1').trigger('change');
                    setTimeout(() => {
                        const preselectedMagicClass1 = $('#magicclass1').data('preselect');
                        if (preselectedMagicClass1 && preselectedMagicClass1 > 0) {
                            $('#magicclass1').val(preselectedMagicClass1).trigger('change');
                            setTimeout(() => {
                                const preselectedSpec1 = $('#spec-container-1 select').data('preselect');
                                if (preselectedSpec1 && preselectedSpec1 > 0) {
                                    $('#spec-container-1 select').val(preselectedSpec1);
                                }
                            }, 100);
                        }
                    }, 100);
                }

                // Vorauswahl laden: Slot 2
                const preselectedObermagie2 = $('#obermagie2').val();
                if (preselectedObermagie2) {
                    $('#obermagie2').trigger('change');
                    setTimeout(() => {
                        const preselectedMagicClass2 = $('#magicclass2').data('preselect');
                        if (preselectedMagicClass2 && preselectedMagicClass2 > 0) {
                            $('#magicclass2').val(preselectedMagicClass2).trigger('change');
                            setTimeout(() => {
                                const preselectedSpec2 = $('#spec-container-2 select').data('preselect');
                                if (preselectedSpec2 && preselectedSpec2 > 0) {
                                    $('#spec-container-2 select').val(preselectedSpec2);
                                }
                            }, 100);
                        }
                    }, 100);
                }
                    
                // Form Submit: Spezialisierung-Namen anpassen
                // (Namen müssen MagicClassId statt Slot-Nummer enthalten)
                $('form').on('submit', function(e) {
                    const magicClass1 = $('#magicclass1').val();
                    const spec1Select = $('#spec-container-1 select');
                    const spec1Value = spec1Select.val();

                    if (magicClass1 && spec1Value) {
                        spec1Select.attr('name', `selectedSpecializations[${magicClass1}]`);
                    }

                    const magicClass2 = $('#magicclass2').val();
                    const spec2Select = $('#spec-container-2 select');
                    const spec2Value = spec2Select.val();

                    if (magicClass2 && spec2Value) {
                        spec2Select.attr('name', `selectedSpecializations[${magicClass2}]`);
                    }
                });
            }
        });
    </script>
}