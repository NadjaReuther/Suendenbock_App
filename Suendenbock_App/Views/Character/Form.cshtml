@using Suendenbock_App.Models.Domain
@model Character
@{
    ViewData["Title"] = Model != null && Model.Id > 0 ? "Charakter bearbeiten" : "Charakter erstellen";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    // Vereinfachte Step-Logik
    int currentStep = 1;
    if (ViewBag.Step != null)
    {
        currentStep = (int)ViewBag.Step;
    }
    else if (Model != null)
    {
        currentStep = (int)Model.CompletionLevel;
    }
}

@section Styles {
    <link href="/css/character.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Uncial+Antiqua&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
}

<div class="steckbrief-background">
    <div class="steckbrief-container">
        <div class="steckbrief-title">@ViewData["Title"]</div>
        <!-- drei Schritt Navigation -->
        <div class="step-navigation">
            <div class="step-item @(currentStep >= 1 ? "active" : "") @(currentStep > 1 ? "completed" : "")">
                <div class="step-number">1</div>
                <div class="step-title">Basis-Informationen</div>
                <div class="step-connector"></div>
            </div>
            <div class="step-item @(currentStep >= 2 ? "active" : "") @(currentStep > 2 ? "completed" : "")">
                <div class="step-number">2</div>
                <div class="step-title">Persönliche Details</div>
                <div class="step-connector"></div>
            </div>
            <div class="step-item @(currentStep >= 3 ? "active" : "")">
                <div class="step-number">3</div>
                <div class="step-title">Zugehörigkeiten</div>
            </div>
        </div>

        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show mt-3">
                @TempData["Success"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show mt-3">
                @TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <!-- Schritt 1: Basis Informationen -->
        <div class="form-step @(currentStep == 1 ? "active" : "")" data-step="1">
            <form asp-controller="Character" asp-action="SaveStep1" method="post" enctype="multipart/form-data">
                @if (Model != null && Model.Id > 0)
                {
                    <input type="hidden" name="Id" value="@Model.Id" />
                }
                <div class="row mt-5">
                    <div class="col-md-6 text-center">
                        <div class="image-upload-container">
                            <div class="image-preview" id="character-drop-zone" onclick="document.getElementById('characterImageUpload').click()">
                                @if (!string.IsNullOrEmpty(Model?.ImagePath))
                                {
                                    <img src="@Model.ImagePath" alt="Charakterbild" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;" />
                                }
                                else
                                {
                                    <div class="image-placeholder">
                                        <span>👤</span>
                                        <div>Portrait<br><small>Klicken zum Hochladen</small></div>
                                    </div>
                                }
                                <div class="drop-zone-hint">📁 Datei hier ablegen</div>
                            </div>
                            <input type="file" id="characterImageUpload" name="characterImage" accept="image/jpeg,image/jpg,image/png" style="display: none;" onchange="previewImage(this, '#character-drop-zone')">
                            <button type="button" class="image-upload-btn" onclick="document.getElementById('characterImageUpload').click()">
                                📷 Bild wählen
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="row mb-3">
                            <input type="text" class="form-control" id="vorname" name="vorname"
                                    value="@(Model != null ? Model.Vorname : "")" required placeholder="Vorname *">
                        </div>
                        <div class="row mb-3">
                            <input type="text" class="form-control" id="nachname" name="nachname"
                                   value="@(Model != null ? Model.Nachname : "")" required placeholder="Nachname *">
                        </div>
                        <div class="row mb-3">
                            <input type="text" class="form-control" id="rufname" name="rufname"
                               value="@(Model != null ? Model.Rufname : "")" required placeholder="Rufname *">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="geschlecht" class="form-label">Geschlecht *</label>
                        <select class="form-select" id="geschlecht" name="geschlecht" required>
                            <option value="">Geschlecht auswählen...</option>
                            @if (Model != null && Model.Geschlecht == "männlich")
                            {
                                <option value="männlich" selected>männlich</option>
                            }
                            else
                            {
                                <option value="männlich">männlich</option>
                            }

                            @if (Model != null && Model.Geschlecht == "weiblich")
                            {
                                <option value="weiblich" selected>weiblich</option>
                            }
                            else
                            {
                                <option value="weiblich">weiblich</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="geburtsdatum" class="form-label">Geburtsdatum</label>
                        <input type="date" class="form-control" id="geburtsdatum" name="geburtsdatum" value="@(Model?.Geburtsdatum ?? "")" min="100-01-01" max="1619-12-31" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="rasseId" class="form-label">Rasse *</label>
                        <select class="form-select" id="rasseId" name="rasseId" required>
                            <option value="">Rasse auswählen...</option>
                            @if(ViewBag.Rassen != null)
                            {
                                foreach (var rasse in ViewBag.Rassen)
                                {
                                    if(Model != null && Model.Rasse.Name == rasse.Name)
                                    {
                                        <option value="@rasse.Id" selected>@rasse.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@rasse.Id">@rasse.Name</option>
                                    }
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="lebensstatusId" class="form-label">Lebensstatus *</label>
                        <select class="form-select" id="lebensstatusId" name="lebensstatusId" required>
                            <option value="">Lebensstatus auswählen...</option>
                            @if (ViewBag.Lebensstatus != null)
                            {
                                foreach(var status in ViewBag.Lebensstatus)
                                {
                                    if(Model != null && Model.Lebensstatus.Name == status.Name)
                                    {
                                        <option value="@status.Id" selected>@status.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@status.Id">@status.Name</option>
                                    }
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="eindruckId" class="form-label">Eindruck *</label>
                        <select class="form-select" id="eindruckId" name="eindruckId" required>
                            <option value="">Eindruck auswählen...</option>
                            @if (ViewBag.Eindruecke != null)
                            {
                                foreach(var eindruck in ViewBag.Eindruecke)
                                {
                                    if(Model != null && Model.Eindruck.Name == eindruck.Name)
                                    {
                                        <option value="@eindruck.Id" selected>@eindruck.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@eindruck.Id">@eindruck.Name</option>
                                    }
                                }
                            }
                        </select>
                    </div>
                </div>

                <!-- Magieklassen -->
                <div class="mb-3">
                    <label class="form-label">Magieklassen (maximal 2) *</label>
                    <div class="card p-3">
                        <div class="row" id="magicClassContainer">
                            @if (ViewBag.MagicClasses != null)
                            {
                                var selectedMagicClasses = ViewBag.SelectedMagicClasses as int[] ?? new int[0];
                                foreach (var magicclass in ViewBag.MagicClasses)
                                {
                                    bool isSelected = Array.Exists(selectedMagicClasses, x => x == magicclass.Id);
                                    <div class="col-md-3 col-sm-6 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input magic-class-checkbox" type="checkbox"
                                                    name="selectedMagicClasses"
                                                    value="@magicclass.Id"
                                                    id="magic-@magicclass.Id"
                                                    @(isSelected ? "checked" : "")>
                                            <label class="form-check-label" for="magic-@magicclass.Id">
                                                <div class="d-flex align-items-center">
                                                    @if (!string.IsNullOrEmpty(magicclass.ImagePath))
                                                    {
                                                        <img src="@magicclass.ImagePath" class="magicclassIcon me-2" alt="@magicclass.Bezeichnung" />
                                                    }
                                                    <span>@magicclass.Bezeichnung</span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>

                <!-- Spezialisierungen -->
                <div class="mb-3" id="specializationsContainer">
                    <label class="form-label">Spezialisierungen</label>
                    <div class="card p-3">
                        <div class="row" id="specializationsRow">
                            @if (ViewBag.MagicClasses != null && ViewBag.Specializations != null)
                            {
                                var selectedMagicClasses = ViewBag.SelectedMagicClasses as int[] ?? new int[0];
                                var selectedSpecializations = ViewBag.SelectedSpecializations as Dictionary<int, int> ?? new Dictionary<int, int>();
                                var allSpecializations = ViewBag.Specializations as List<MagicClassSpecialization> ?? new List<MagicClassSpecialization>();

                                foreach (var magicClass in ViewBag.MagicClasses)
                                {
                                    var specializations = allSpecializations.Where(s => s.MagicClassId == magicClass.Id).ToList();

                                    if (specializations.Any())
                                    {
                                        <div class="col-md-6 mb-3 specialization-column" data-magic-class-id="@magicClass.Id" style="display: none;">
                                            <label class="form-label">@magicClass.Bezeichnung</label>
                                            <select class="form-select" name="selectedSpecializations[@magicClass.Id]">
                                                <option value="">Keine Spezialisierung</option>
                                                @foreach (var spec in specializations)
                                                {
                                                    bool isSpecSelected = false;
                                                    if (selectedSpecializations.ContainsKey(magicClass.Id))
                                                    {
                                                        if (selectedSpecializations[magicClass.Id] == spec.Id)
                                                        {
                                                            isSpecSelected = true;
                                                        }
                                                    }
                                                    @if (isSpecSelected)
                                                    {
                                                        <option value="@spec.Id" selected>@spec.Name</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@spec.Id">@spec.Name</option>
                                                    }
                                                }
                                            </select>
                                        </div>
                                    }
                                }
                            }
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <button type="submit" class="btn-wachs">Gebilligt</button>
                </div>
            </form>
        </div>

        <!-- Schritt 2: Persönliche Details -->
        <div class="form-step @(currentStep == 2 ? "active" : "")" data-step="2">
            @if (Model != null && Model.Id > 0)
            {
                <form asp-controller="Character" asp-action="SaveStep2" method="post">
                    <input type="hidden" name="Id" value="@Model.Id" />

                    <h4 class="text-center mb-4" style="color: #6e4b1f;">🏰 Persönliche Details</h4>
                        
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="standId" class="form-label">Stand</label>
                            <select class="form-select" id="standId" name="standId">
                                <option value="">Stand auswählen...</option>
                                @if (ViewBag.Staende != null)
                                {
                                    foreach (var stand in ViewBag.Staende)
                                    {
                                        if (Model?.Details?.Stand == stand)
                                        {
                                            <option value="@stand.Id" selected>@stand.Name</option>
                                        }
                                        else
                                        {
                                            <option value="@stand.Id">@stand.Name</option>
                                        }
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="berufId" class="form-label">Beruf</label>
                            <input type="text" class="form-control" id="berufId" name="berufId"
                                   value="@(Model != null ? Model?.Details?.BerufId : "")" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="hausId" class="form-label">Haus</label>
                            <select class="form-select" id="hausId" name="hausId">
                                <option value="">Haus auswählen...</option>
                                @if (ViewBag.Haeuser != null)
                                {
                                    foreach (var haus in ViewBag.Haeuser)
                                    {
                                        if (Model?.Details?.Haus?.Name == haus.Name)
                                        {
                                            <option value="@haus.Id" selected>@haus.Name</option>
                                        }
                                        else
                                        {
                                            <option value="@haus.Id">@haus.Name</option>
                                        }
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="herkunftslandId" class="form-label">Herkunftsland</label>
                            <select class="form-select" id="herkunftslandId" name="herkunftslandId">
                                <option value="">Herkunftsland wählen...</option>
                                @if (ViewBag.Herkunftslaender != null)
                                {
                                    foreach (var herkunftsland in ViewBag.Herkunftslaender)
                                    {
                                        if (Model?.Details?.Herkunftsland?.Name == herkunftsland.Name)
                                        {
                                            <option value="@herkunftsland.Id" selected>@herkunftsland.Name</option>
                                        }
                                        else
                                        {
                                            <option value="@herkunftsland.Id">@herkunftsland.Name</option>
                                        }
                                    }
                                }
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6  mb-3">
                            <label for="blutgruppeId" class="form-label">Blutgruppe</label>
                            <select class="form-select" id="blutgruppeId" name="blutgruppeId">
                                <option value="">Blutgruppe wählen...</option>
                                @if(ViewBag.Blutgruppen != null)
                                {
                                    foreach(var blutgruppe in ViewBag.Blutgruppen)
                                    {
                                        if(Model?.Details?.Blutgruppe?.Name == blutgruppe.Name)
                                        {
                                            <option value="@blutgruppe.Id" selected>@blutgruppe.Name</option>
                                        }                                        
                                        else
                                        {
                                            <option value="@blutgruppe.Id">@blutgruppe.Name</option>
                                        }
                                    }                                    
                                }                     
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="bodyHeight" class="form-label">Körpergröße (cm)</label>
                            <input type="number" class="form-control" id="bodyHeight" name="bodyHeight" 
                                    value="@(Model?.Details?.BodyHeight ?? 0)" placeholder="z.B. 175" min="50" max="600" />         
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <a href="@Url.Action("Form", new { id = Model?.Id, step = 1 })" class="btn btn-secondary me-3">
                            ← Zurück zu Schritt 1
                        </a>
                        <button type="submit" class="btn-wachs">Gebilligt</button>
                    </div>
                </form>
            }
            else
            {
                <div class="alert alert-warning">
                    Bitte speichern Sie zuerst die Basis-Informationen, um mit den persönlichen Details fortzufahren.
                </div>
            }
            </div>

        <!-- Schritt 3: Zugehörigkeiten -->
        <div class="form-step @(currentStep == 3 ? "active" : "")" data-step="3">
            @if (Model != null && Model.Id > 0)
            {
                <form asp-controller="Character" asp-action="SaveStep3" method="post">
                    <input type="hidden" name="Id" value="@Model.Id" />
                
                    <h4 class="text-center mb-4" style="color: #6e4b1f;">⚔️ Zugehörigkeiten</h4>
                
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="guldId" class="form-label">Gilde</label>
                            <select class="form-select" id="guildId" name="guildId">
                                <option value="" disabled selected>Gilde auswählen...</option>
                                @if (ViewBag.Guilds != null)
                                {
                                    foreach (var guild in ViewBag.Guilds)
                                    {
                                        if(Model?.Affiliation?.Guild?.Name == guild.Name)
                                        {
                                            <option value="@guild.Id" selected>@guild.Name</option>
                                        }
                                        else
                                        {
                                            <option value="@guild.Id">@guild.Name</option>
                                        }
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="religionId" class="form-label">Religion</label>
                            <select class="form-select" id="religionId" name="religionId">
                                <option value="" disabled selected>Religion auswählen...</option>
                                @if (ViewBag.Religions != null)
                                {
                                    foreach (var religion in ViewBag.Religions)
                                    {
                                        if(Model?.Affiliation?.Religion?.Type == religion.Type)
                                        {
                                            <option value="@religion.Id" selected>@religion.Type</option>
                                        }
                                        else
                                        {
                                            <option value="@religion.Id" selected>@religion.Type</option>  
                                        }
                                    }
                                }
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                        <label for="regimentsId" class="form-label">Regiment</label>
                        <select class="form-select" name="regimentsId">
                            <option value="">Regiment wählen...</option>
                            @if(ViewBag.Regiment != null)
                            {
                                foreach(var regiment in ViewBag.Regiment)
                                {
                                    if(Model?.Affiliation?.Regiment?.Name == regiment.Name)
                                    {
                                        <option value="@regiment.Id" selected>@regiment.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@regiment.Id">@regiment.Name</option>
                                    }
                                }
                            }                                                            
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="infanterierangId" class="form-label">Infanterierang</label>
                        <select class="form-select" id="infanterierangId" name="infanterierangId">
                            <option value="">Infanterierang wählen...</option>
                            @if(ViewBag.Infanterieraenge != null)
                            {
                                foreach(var infanterierang in ViewBag.Infanterieraenge)
                                {
                                    if(Model?.Affiliation?.Infanterierang?.Name == infanterierang.Name)
                                    {
                                        <option value="@infanterierang.Id" selected>@infanterierang.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@infanterierang.Id">@infanterierang.Name</option>
                                    }
                                }
                            }                     
                        </select>
                    </div>
                </div>
                    
                <div class="text-center mt-4">
                    <div class="alert alert-success mb-3">
                        <strong>🎉 Fast geschafft!</strong><br>
                        Überprüfe deine Angaben und schließe die Charaktererstellung ab.
                    </div>
                    <a href="@Url.Action("Form", new { id = Model?.Id, step = 2 })" class="btn btn-secondary me-3">
                        ← Zurück zu Schritt 2
                    </a>
                    <button type="submit" class="btn-wachs">Gebilligt</button>
                </div>
            </form>
        }
        else
        {
            <div class="alert alert-warning">
                Bitte speichern Sie zuerst die vorherigen Schritte, um fortzufahren.
            </div>
        }
          
        </div>
    </div>
</div>

@section Scripts {
    
    <script src="~/js/imagePreview.js"></script>
    <script>
        // Bild-Upload Drag & Drop aktivieren
        enableImageDragDrop('#character-drop-zone', 'characterImageUpload');

        $(document).ready(function() {

            $('form[asp-action="SaveStep1"]').on('submit', function(e) {
                var checkedCount = $('input[name="selectedMagicClasses"]:checked').length;

                if (checkedCount === 0) {
                    e.preventDefault();
                    alert('Bitte wähle mindestens eine Magieklasse aus.');
                    return false;
                }

                if (checkedCount > 2) {
                    e.preventDefault();
                    alert('Du kannst maximal 2 Magieklassen auswählen.');
                    return false;
                }

                // Wenn alles OK ist, nichts machen -> normale Übermittlung
            });
            // Väter (nur männlich)
            $('.character-select-male').select2({
                ajax: {
                    url: '/api/Character/dropdown',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            search: params.term,
                            page: params.page || 1,
                            gender: 'männlich',
                            excludeId: @(Model?.Id ?? 0)
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.results.map(item => ({
                                id: item.id,
                                text: item.fullName
                            }))
                        };
                    },
                    cache: true
                },
                minimumInputLength: 1,
                placeholder: 'Vater suchen...',
                allowClear: true,
                language: {
                    inputTooShort: function() {
                        return "";
                    },
                    noResults: function() {
                        return "Keine männlichen Charaktere gefunden";
                    },
                    searching: function() {
                        return "Suche nach Vätern...";
                    }
                }
            });

            // Mütter (nur weiblich)
            $('.character-select-female').select2({
                ajax: {
                    url: '/api/Character/dropdown',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            search: params.term,
                            page: params.page || 1,
                            gender: 'weiblich',
                            excludeId: @(Model?.Id ?? 0)
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.results.map(item => ({
                                id: item.id,
                                text: item.fullName
                            }))
                        };
                    },
                    cache: true
                },
                minimumInputLength: 1,
                placeholder: 'Mutter suchen...',
                allowClear: true,
                language: {
                    inputTooShort: function() {
                        return "";
                    },
                    noResults: function() {
                        return "Keine weiblichen Charaktere gefunden";
                    },
                    searching: function() {
                        return "Suche nach Müttern...";
                    }
                }
            });

            // Maximal 2 Checkboxen erlauben
            $('input[name="selectedMagicClasses"]').change(function() {
                var checkedCount = $('input[name="selectedMagicClasses"]:checked').length;
                if (checkedCount > 2) {
                    this.checked = false;
                    alert('Du kannst maximal 2 Magieklassen auswählen.');
                }
                // Zeige/Verstecke Spezialisierungen
                toggleSpecializations();
            });

            function toggleSpecializations() {
                // Alle Spezialisierungen verstecken
                $('.specialization-column').hide();

                // Nur die der ausgewählten Magieklassen zeigen
                $('input[name="selectedMagicClasses"]:checked').each(function() {
                    var magicClassId = $(this).val();
                    $('.specialization-column[data-magic-class-id="' + magicClassId + '"]').show();
                });
            }

            // Beim Laden der Seite Spezialisierungen aktualisieren
            toggleSpecializations();
        });
    </script>
}