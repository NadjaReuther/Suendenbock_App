@using Suendenbock_App.Models.Domain
@model Guild
@{
    ViewData["Title"] = Model.Id == 0 ? "Neue Gilde" : "Gilde bearbeiten";
    Layout = "_AdminLayout";
}
@section Styles {
    <link href="/css/character.css" rel="stylesheet" />
    <link href="/css/wysiwyg-editor.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Uncial+Antiqua&display=swap" rel="stylesheet">
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
        <strong>Fehler:</strong> @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show">
        <strong>Erfolg:</strong> @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="steckbrief-container">
    <div class="steckbrief-title">Gilde</div>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="Admin" asp-action="Index">Admin</a></li>
            <li class="breadcrumb-item active">@ViewData["Title"]</li>
        </ol>
    </nav>
    <form id="formular" asp-controller="Guild" asp-action="CreateEdit" method="post" enctype="multipart/form-data">
        @if (Model != null && Model.Id > 0)
        {
            <input type="hidden" name="Id" value="@Model.Id" />
        }
        <div class="mb-3">
            <label for="gildenname" class="form-label">Gildenname</label>
            <input type="text" class="form-control" id="Name" name="Name" value="@(Model?.Name ?? "")" required />
        </div>
        <div class="row mb-3">
            <div class="col-lg-7">
                <label for="beschreibung" class="form-label">Beschreibung</label>
                <div id="editor-wrapper">
                    <textarea class="form-control d-none" id="description" name="description" required>@(Model?.Description ?? "")</textarea>
                    <div id="wysiwyg-editor"></div>
                </div>
            </div>
            <div class="col-lg-5">
                <!--spezielles Zeichen der Gilde wird über Bild hochladen und speichern das Imagepath angezeigt-->
                <label for="gildenlogo" class="form-label">Gildenlogo</label>
                <div class="image-upload-container">
                    <div class="image-preview" id="guild-drop-zone" onclick="document.getElementById('gildenlogoUpload').click()">
                        @if (!string.IsNullOrEmpty(Model?.ImagePath))
                        {
                            <img src="@Model.ImagePath" alt="Gildenlogo" style="width: 100%; height: 100%; object-fit: cover;">
                        }
                        else
                        {
                            <div class="image-placeholder">
                                <span>🏰</span>
                                <div>Gildenlogo<br><small>Klicken zum Hochladen</small></div>
                            </div>
                        }
                    </div>
                    <input type="file" id="gildenlogoUpload" name="gildenlogo" accept="image/jpeg,image/jpg,image/png" style="display: none;" onchange="previewImage(this, '.image-preview')">
                    <button type="button" class="image-upload-btn" onclick="document.getElementById('gildenlogoUpload').click()">
                        📷 Logo wählen
                    </button>
                </div>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-lg-6">
                <!--combobox mit den charakternamen aus der charaktertabelle Eintragung dann auch zum jeweiligen Charakter-->
                <label for="leader" style="width: 100%;">Gildenmeister
                <select class="form-control character-select js-states" id="leader" name="LeaderId" required>
                    @if (Model?.LeaderId != null)
                    {
                        <option value="@Model.LeaderId" selected>@Model?.LeaderCharacter?.Vorname @Model?.LeaderCharacter?.Nachname</option>
                    }
                </select>
                </label>
            </div>
            <div class="col-lg-6">
                <!--combobox mit den charakternamen aus der Charaktertabelle Eintragung dann auch zum jeweiligen Charakter-->
                <label for="vertreter" style="width: 100%;">
                    Stellvertreter
                    <select class="form-control character-select js-states" id="vertreter" name="VertreterId" required>
                        @if (Model?.VertreterId != null)
                        {
                            <option value="@Model.VertreterId" selected>@Model?.VertreterCharacter?.Vorname @Model?.VertreterCharacter?.Nachname</option>
                        }
                    </select>
                </label>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Gildenfarbe</label>
            <div class="row">
                <div class="col-12 mb-2 d-flex">
                    <div class="btn-group w-100 d-flex" role="group">
                    @if (ViewBag.LightCards != null)
                    {
                    // Erste Reihe
                            foreach (var lightCard in ViewBag.LightCards)
                            {                                
                                <input type="radio"
                                        class="btn-check"
                                        name="lightCardId"
                                        id="lightcard-@lightCard.Id"
                                        value="@lightCard.Id"
                                       @(Model?.LightCardId == lightCard.Id ? "checked" : "")>                            
                                <label class="btn flex-fill"
                                       for="lightcard-@lightCard.Id"
                                       style="background-color: @lightCard.Farbcode; border-color: @lightCard.Farbcode; width: 30px; height: 30px; margin: 3px; border-radius: 5px; border: 2px solid darkgrey;"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       title="@(lightCard.Bezeichnung)">
                                </label>
                            }
                    }
                    </div>
                </div>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-lg-6">
                <label for="gildenstatus" class="form-label">Gildenstatus</label>
                <select class="form-select" id="AnmeldungsstatusId" name="AnmeldungsstatusID" required>
                    <option value="" disabled selected>Anmeldestatus auswählen...</option>
                    @if(ViewBag.Anmeldungsstatus != null)
                    {
                        foreach (var status in ViewBag.Anmeldungsstatus)
                        {
                            if(Model?.AnmeldungsstatusId != null && Model?.AnmeldungsstatusId == status.Id)
                            {
                                <option value="@status.Id" selected>@status.Name</option>
                            }
                            else
                            {
                                <option value="@status.Id">@status.Name</option>
                            }
                        }
                    }
                
                </select>
            </div>
            <div class="col-lg-6">
                <label for="gildenrang" class="form-label">Gildenrang</label>
                <select class="form-select" id="AbenteuerrangId" name="AbenteuerrangId" required>
                    <option value="" disabled selected>Gildenrang auswählen...</option>
                    @if(ViewBag.Abenteuerrang != null)
                    {
                        foreach (var rang in ViewBag.Abenteuerrang)
                        {
                            if(Model?.AbenteuerrangId != null && Model?.AbenteuerrangId == rang.Id)
                            {
                                <option value="@rang.Id" selected>@rang.Name</option>
                            }
                            else
                            {
                                <option value="@rang.Id">@rang.Name</option>
                            }
                        }
                    }
                </select>
            </div>
        </div>
        <div class="text-center">
            <button type="submit" class="btn-wachs">Gebilligt</button>
        </div>
    </form>
</div>
@section Scripts {
    <script src="~/js/imagePreview.js"></script>
    <script src="~/js/wysiwyg-editor.js"></script>
    <script src="~/js/entity-mentions.js"></script>
    <script>
        // Tooltips aktivieren
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        enableImageDragDrop('#guild-drop-zone', 'gildenlogoUpload');

        $(document).ready(function() {
            // Zuerst WYSIWYG-Editor initialisieren
            const wikiEditor = new WikiWYSIWYGEditor('#description');

            // Dann EntityMentions mit kleiner Verzögerung
            setTimeout(() => {
                console.log('🔄 Initialisiere EntityMentions...');
                new EntityMentions('#description');
            }, 800);
            // Charakterauswahl mit Suche und AJAX
            $('.character-select').select2({
                ajax: {
                    url: '/api/Character/dropdown',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            search: params.term,
                            page: params.page || 1
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.results.map(item => ({
                                id: item.id,
                                text: item.fullName
                            }))
                        };
                    },
                    cache: true
                },
                minimumInputLength: 1,
                placeholder: 'Namen eingeben...',
                allowClear: false,
                language: {
                    inputTooShort: function() {
                        return ""; // ✅ Keine Meldung anzeigen
                    },
                    noResults: function() {
                        return "Keine Charaktere gefunden";
                    },
                    searching: function() {
                        return "Suche...";
                    }
                }
            });
        });
        
    </script>
}