@model Character
@using Suendenbock_App.Models.Domain
@{
    ViewData["Title"] = "Meine Character";
}
<!-- SignalR Hidden Inputs - Verwendet ActNumber (nicht DB-ID) -->
<input type="hidden" id="global-act-id" value="@ViewBag.CurrentActId" />
<input type="hidden" id="global-user-name" value="@User.Identity.Name" />
<!-- DEBUG: ViewBag.CurrentActId (ActNumber) = @ViewBag.CurrentActId -->
<div class="p-5 m-5 pergament-card" style="background: @Model.UserColor;">
<header class="antique-header">
    <h1 style="text-align:center; color: #d4af37; font-family: 'MedievalSharp', cursive">
        Herzlich Willkommen zurück, @Model.Rufname
    </h1>
</header>

<div class="main-container mt-5">
    <section class="player-section">
    <div class="pergament-card" data-tilt>
        <a class="card-link" asp-action="MeineDaten">
            <div class="card-corner top-left"></div>
            <div class="card-corner top-right"></div>
            <div class="card-corner bottom-left"></div>
            <div class="card-corner bottom-right"></div>

            <div class="card-number">Profil</div>
            <!--<h5 class="card-title">Charaktere</h5>-->
            <div class="card-content">
                deine persönlichen<br />Daten ändern
            </div>
        </a>
    </div>
     @if (Model != null)
       {
            <div class="pergament-card" data-tilt>
                <a class="card-link" asp-controller="Character" asp-action="Form" asp-route-id="@Model.Id">
                    <div class="card-corner top-left"></div>
                    <div class="card-corner top-right"></div>
                    <div class="card-corner bottom-left"></div>
                    <div class="card-corner bottom-right"></div>
                    
                    <div class="card-number">Character</div>
                    <div class="card-content">
                        eigenen Charakter<br />bearbeiten
                    </div>
                </a>
            </div>                        
       }
      else
       {
            <div class="pergament-card" data-tilt>
                <a class="card-link">
                    <div class="card-corner top-left"></div>
                    <div class="card-corner top-right"></div>
                    <div class="card-corner bottom-left"></div>
                    <div class="card-corner bottom-right"></div>
                    
                    <div class="card-number">Character</div>
                    <div class="card-content">
                        eigenen Charakter<br />bearbeiten
                    </div>
                </a>
            </div>                        
        }
               
    <div class="pergament-card" data-tilt>
        <a class="card-link" asp-action="Achievements">
            <div class="card-corner top-left"></div>
            <div class="card-corner top-right"></div>
            <div class="card-corner bottom-left"></div>
            <div class="card-corner bottom-right"></div>

            <div class="card-number">Erfolge</div>
            <!--<h5 class="card-title">Charaktere</h5>-->
            <div class="card-content">
                alle Achievements<br>
                die du freigespielt hast
            </div>
        </a>
    </div>
    <div class="pergament-card" data-tilt>
        <a class="card-link" asp-controller="Player" asp-action="Weihnachtenuebersicht">
            <div class="card-corner top-left"></div>
            <div class="card-corner top-right"></div>
            <div class="card-corner bottom-left"></div>
            <div class="card-corner bottom-right"></div>

            <div class="card-number">Weihnachten</div>
            <!--<h5 class="card-title">Charaktere</h5>-->
            <div class="card-content">
                hier kommt alles<br>
                zum Weihnachtsabenteuer und Adventskalender
            </div>
        </a>
    </div>
        <div class="pergament-card" data-tilt>
            <a class="card-link" asp-controller="Player" asp-action="Adventskalender">
                <div class="card-corner top-left"></div>
                <div class="card-corner top-right"></div>
                <div class="card-corner bottom-left"></div>
                <div class="card-corner bottom-right"></div>

                <div class="card-number">Advents-Statistik</div>
                <!--<h5 class="card-title">Charaktere</h5>-->
                <div class="card-content">
                   Statistik zum Adventskalender
                </div>
            </a>
        </div>
        <!-- Aktiver Kampf Card (nur sichtbar wenn Kampf läuft) -->
        <div id="activeCombatCard" class="pergament-card" data-tilt style="display: none;">
            <a class="card-link" href="#" onclick="joinActiveCombat(); return false;">
                <div class="card-corner top-left"></div>
                <div class="card-corner top-right"></div>
                <div class="card-corner bottom-left"></div>
                <div class="card-corner bottom-right"></div>

                <div class="card-number" style="color: #ff6b6b;">⚔️ Kampf</div>
                <div class="card-content">
                   <strong style="color: #ff6b6b;">Aktiver Kampf!</strong><br>
                   Zum Gefecht beitreten
                </div>
            </a>
        </div>

        <div class="pergament-card" data-tilt>
            <a class="card-link" asp-controller="Spielmodus" asp-action="Dashboard">
                <div class="card-corner top-left"></div>
                <div class="card-corner top-right"></div>
                <div class="card-corner bottom-left"></div>
                <div class="card-corner bottom-right"></div>

                <div class="card-number">Spielmodus</div>
                <div class="card-content">
                   Zum aktuellen Act<br>
                   Dashboard
                </div>
            </a>
        </div>

        <div class="pergament-card" data-tilt>
            <a class="card-link" asp-controller="Community" asp-action="Index">
                <div class="card-corner top-left"></div>
                <div class="card-corner top-right"></div>
                <div class="card-corner bottom-left"></div>
                <div class="card-corner bottom-right"></div>

                <div class="card-number">Versammlung</div>
                <div class="card-content">
                   Gemeinschaft & Forum<br>
                   für die Gilde
                </div>
            </a>
        </div>
    </section>
</div>
</div>
@section Scripts {
    <!-- SignalR Client Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <!-- Global SignalR direkt hier eingebunden -->
    <script src="~/js/global-signalr.js" asp-append-version="true"></script>

    <script>
        // SignalR übernimmt jetzt die Benachrichtigung!
        // Das global-signalr.js Script leitet automatisch zum Kampf weiter
        // Hier nur noch die Karte anzeigen, falls beim Laden bereits ein Kampf aktiv ist

        async function checkActiveCombat() {
            try {
                const actIdElement = document.getElementById('global-act-id');
                if (!actIdElement || !actIdElement.value) {
                    console.log('[Player] Keine ActId gefunden');
                    return;
                }

                const actId = parseInt(actIdElement.value);
                const response = await fetch(`/api/battle/active/${actId}`);

                if (response.ok) {
                    const data = await response.json();
                    // Kampf ist aktiv - Card anzeigen
                    document.getElementById('activeCombatCard').style.display = 'block';
                    // SessionId für später speichern
                    window.activeCombatSessionId = data.sessionId;
                    window.activeCombatData = data;
                } else {
                    // Kein aktiver Kampf
                    document.getElementById('activeCombatCard').style.display = 'none';
                }
            } catch (error) {
                console.error('[Player] Fehler beim Prüfen des aktiven Kampfes:', error);
            }
        }

        async function joinActiveCombat() {
            if (!window.activeCombatSessionId) {
                alert('Keine aktiven Kampfdaten gefunden!');
                return;
            }

            // Direkt zur Battle-Seite mit SessionId in URL
            window.location.href = `/Spielmodus/Battle?sessionId=${window.activeCombatSessionId}`;
        }

        // Beim Laden der Seite EINMALIG prüfen (kein Polling mehr!)
        document.addEventListener('DOMContentLoaded', () => {
            checkActiveCombat();
        });
    </script>
}