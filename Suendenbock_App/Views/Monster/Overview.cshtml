@using Suendenbock_App.Models.Domain
@model List<Monstertyp>
@{
    var selectedMonsterId = ViewBag.SelectedMonsterId as int?;
    var selectedMonstertypId = ViewBag.SelectedMonstertypId as int?;
    var isGod = ViewBag.IsGod as bool? ?? false;
}

@section Styles {
    <link href="/css/wiki.css" rel="stylesheet" />
}

<div class="monster-overview-container">
    <header class="antique-header mb-4">
        <h1 class="main-title">üëπ Bestiarium</h1>
        <p class="subtitle">Begegnete Kreaturen und ihre Geheimnisse</p>
        @if (isGod)
        {
            <div class="alert alert-info mt-3" style="font-family: 'Cinzel', serif; font-size: 0.9rem;">
                <strong>Gott-Ansicht:</strong> Du siehst alle Monster. Das Icon üëÅÔ∏è‚Äçüó®Ô∏è markiert Monster, die f√ºr Spieler noch nicht sichtbar sind.
            </div>
        }
    </header>

    @if (Model != null && Model.Any(mt => mt.Monster.Any()))
    {
        <div class="accordion monster-accordion" id="monsterAccordion">
            @foreach (var monsterType in Model.Where(mt => mt.Monster.Any()))
            {
                var typeId = $"type{monsterType.Id}";
                var isTypeOpen = selectedMonstertypId == monsterType.Id || monsterType.Monster.Any(m => m.Id == selectedMonsterId);
                var meetCount = monsterType.Monster.Count(m => m.meet);
                var totalCount = monsterType.Monster.Count();

                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading@(typeId)">
                        <button class="accordion-button @(isTypeOpen ? "" : "collapsed")" type="button"
                                data-bs-toggle="collapse" data-bs-target="#collapse@(typeId)"
                                aria-expanded="@(isTypeOpen ? "true" : "false")" aria-controls="collapse@(typeId)">
                            <h3>@monsterType.Name</h3>
                            <span class="ms-auto me-3" style="font-size: 0.9rem;">
                                @if (isGod)
                                {
                                    <text>(@meetCount/@totalCount f√ºr Spieler sichtbar)</text>
                                }
                                else
                                {
                                    <text>(@meetCount/@totalCount entdeckt)</text>
                                }
                            </span>
                        </button>
                    </h2>
                    <div id="collapse@(typeId)" class="accordion-collapse collapse @(isTypeOpen ? "show" : "")"
                         aria-labelledby="heading@(typeId)" data-bs-parent="#monsterAccordion">
                        <div class="accordion-body">
                            @foreach (var monster in monsterType.Monster)
                            {
                                var isLocked = !monster.meet && !isGod;
                                var isHiddenFromPlayers = !monster.meet;
                                var monsterId = $"monster{monster.Id}";
                                var isMonsterOpen = selectedMonsterId == monster.Id;

                                <div class="accordion monster-accordion mb-3" id="accordion@(monsterId)">
                                    <div class="accordion-item @(isLocked ? "locked-monster" : "")">
                                        <h2 class="accordion-header" id="heading@(monsterId)">
                                            <button class="accordion-button @(isMonsterOpen ? "" : "collapsed")" type="button"
                                                    data-bs-toggle="collapse" data-bs-target="#collapse@(monsterId)"
                                                    aria-expanded="@(isMonsterOpen ? "true" : "false")" aria-controls="collapse@(monsterId)"
                                                    style="display: flex; align-items: center;">
                                                @if (isLocked)
                                                {
                                                    <span style="margin-right: 0.75rem; font-size: 1.2rem;">üîí</span>
                                                }
                                                else if (!string.IsNullOrEmpty(monster.ImagePath))
                                                {
                                                    <img src="@monster.ImagePath" alt="@monster.Name"
                                                         style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #d4af37; margin-right: 0.75rem; object-fit: cover;">
                                                }
                                                else
                                                {
                                                    <span style="margin-right: 0.75rem; font-size: 1.2rem;">üëπ</span>
                                                }
                                                <span style="@(isLocked ? "filter: blur(3px);" : "")">
                                                    @(isLocked ? "???" : monster.Name)
                                                </span>
                                                @if (isGod && isHiddenFromPlayers)
                                                {
                                                    <span class="ms-2" style="font-size: 0.9rem; color: #ff6b6b;" title="F√ºr Spieler nicht sichtbar">
                                                        üëÅÔ∏è‚Äçüó®Ô∏è
                                                    </span>
                                                }
                                                @if((isGod || !isLocked) && monster.encounter && !monster.perfected)
                                                {
                                                    <span class="ms-auto me-3" style="font-size: 0.8rem; color: #C0C0C0;">
                                                        ‚ú® teil erforscht
                                                    </span>
                                                }
                                                @if ((isGod || !isLocked) && monster.perfected)
                                                {
                                                    <span class="ms-auto me-3" style="font-size: 0.8rem; color: #d4af37;">
                                                        ‚ú® komplett erforscht
                                                    </span>
                                                }
                                            </button>
                                        </h2>
                                        <div id="collapse@(monsterId)" class="accordion-collapse collapse @(isMonsterOpen ? "show" : "")"
                                             aria-labelledby="heading@(monsterId)" data-bs-parent="#accordion@(monsterId)">
                                            <div class="accordion-body">
                                                @if (isLocked)
                                                {
                                                    <div class="text-center" style="padding: 2rem;">
                                                        <div style="font-size: 3rem; filter: blur(5px);">üëπ</div>
                                                        <p style="color: #8b7355; margin-top: 1rem;">
                                                            Dieses Monster wurde noch nicht entdeckt
                                                        </p>
                                                        <span class="locked-badge">üîí Nicht freigeschaltet</span>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="monster-image-container">
                                                        @if (!string.IsNullOrEmpty(monster.ImagePath))
                                                        {
                                                            <img src="@monster.ImagePath" alt="@monster.Name">
                                                        }
                                                        else
                                                        {
                                                            <div style="font-size: 4rem;">üëπ</div>
                                                        }
                                                    </div>

                                                    @if (!string.IsNullOrEmpty(monster.Basics))
                                                    {
                                                        <div class="monster-inner-card">
                                                            <h5 style="font-family: 'Cinzel', serif; color: #5d4e37; margin-bottom: 1rem;">
                                                                üìú Basics
                                                                @if (isGod)
                                                                {
                                                                    @if (monster.meet)
                                                                    {
                                                                        <span style="font-size: 0.8rem; color: #28a745; margin-left: 1rem;">‚úì F√ºr Spieler sichtbar</span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span style="font-size: 0.8rem; color: #ff6b6b; margin-left: 1rem;">üëÅÔ∏è‚Äçüó®Ô∏è F√ºr Spieler nicht sichtbar</span>
                                                                    }
                                                                }
                                                            </h5>
                                                            @Html.Raw(monster.Basics)
                                                        </div>
                                                    }

                                                    @if ((isGod || monster.encounter) && !string.IsNullOrEmpty(monster.Description))
                                                    {
                                                        <div class="monster-inner-card">
                                                            <h5 style="font-family: 'Cinzel', serif; color: #5d4e37; margin-bottom: 1rem;">
                                                                üìú Beschreibung
                                                                @if (isGod)
                                                                {
                                                                    @if (monster.encounter)
                                                                    {
                                                                        <span style="font-size: 0.8rem; color: #28a745; margin-left: 1rem;">‚úì F√ºr Spieler sichtbar</span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span style="font-size: 0.8rem; color: #ff6b6b; margin-left: 1rem;">üëÅÔ∏è‚Äçüó®Ô∏è F√ºr Spieler nicht sichtbar</span>
                                                                    }
                                                                }
                                                            </h5>
                                                            @Html.Raw(monster.Description)
                                                        </div>
                                                    }

                                                    @if ((isGod || monster.perfected) && !string.IsNullOrEmpty(monster.ProcessedDescription))
                                                    {
                                                        <div class="monster-inner-card">
                                                            <h5 style="font-family: 'Cinzel', serif; color: #d4af37; margin-bottom: 1rem;">
                                                                ‚ú® Zus√§tzliche Erkenntnisse
                                                                @if (isGod)
                                                                {
                                                                    @if (monster.perfected)
                                                                    {
                                                                        <span style="font-size: 0.8rem; color: #28a745; margin-left: 1rem;">‚úì F√ºr Spieler sichtbar</span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span style="font-size: 0.8rem; color: #ff6b6b; margin-left: 1rem;">üëÅÔ∏è‚Äçüó®Ô∏è F√ºr Spieler nicht sichtbar</span>
                                                                    }
                                                                }
                                                            </h5>
                                                            @Html.Raw(monster.ProcessedDescription)
                                                        </div>
                                                    }

                                                    <div class="text-center">
                                                        @if (monster.perfected)
                                                        {
                                                            <span class="perfected-badge">‚ú® Komplett erforscht</span>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="monster-type-section">
            <div class="no-monsters-message">
                <p>üìú Noch keine Monster begegnet</p>
                <p style="font-size: 0.9rem; color: #8b7355; margin-top: 1rem;">
                    Sobald ihr auf euren Abenteuern Kreaturen begegnet, werden diese hier erscheinen.
                </p>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Automatisch zum aufgeklappten Monster scrollen
        @if (selectedMonsterId.HasValue)
        {
            <text>
            $(document).ready(function() {
                setTimeout(function() {
                    var monsterElement = document.getElementById('collapseMonster@selectedMonsterId');
                    if (monsterElement) {
                        monsterElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 500);
            });
            </text>
        }
    </script>
}
