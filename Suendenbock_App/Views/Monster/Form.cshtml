@using Suendenbock_App.Models.Domain
@model Monster
@{
    ViewData["Title"] = Model.Id == 0 ? "Neues Monster" : "Monster bearbeiten";
}
@section Styles {
    <link href="/css/forms.css" rel="stylesheet" />
    <link href="/css/wysiwyg-editor.css" rel="stylesheet" />
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
        <strong>Fehler:</strong> @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show">
        <strong>Erfolg:</strong> @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="steckbrief-container">
    <div class="steckbrief-title">Monster</div>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="Admin" asp-action="Index">Admin</a></li>
            <li class="breadcrumb-item active">@ViewData["Title"]</li>
        </ol>
    </nav>
    <form asp-controller="Monster" asp-action="CreateEdit" method="post" enctype="multipart/form-data">
        @if (Model != null && Model.Id > 0)
        {
            <input type="hidden" name="Id" value="@Model.Id" />
        }
        <div class="row mb-3">
            <div class="col-6">
                <div class="image-upload-container">
                    <div class="image-preview" id="monster-drop-zone" onclick="document.getElementById('monsterzeichenUpload').click()">
                        @if (!string.IsNullOrEmpty(Model?.ImagePath))
                        {
                            <img src="@Model.ImagePath" alt="@Model.ImagePath" style="width: 100%; height: 100%; object-fit:cover;" />
                        }
                        else
                        {
                            <div class="image-placeholder">                                
                                <div>Monsterbild<br /><small>Klicken zum Hochladen</small></div>
                            </div>
                        }
                    </div>

                    <input type="file" id="monsterzeichenUpload" name="monsterzeichen" accept="image/jpeg,image/jpg,image/png" style="display: none;" onchange="previewImage(this, '.image-preview')">
                    <button type="button" class="image-upload-btn" onclick="document.getElementById('monsterzeichenUpload').click()">📷 Logo wählen</button>
                </div>
            </div>
            <div class="col-5">                
                <div class="row">
                    <input type="text" class="form-control" id="Bezeichnung" asp-for="Name" placeholder="Monsterbezeichnung" required>
                </div>
                <br />
                <br />
                <div class="row">                    
                    <select class="form-select" asp-for="MonstertypId" asp-items="ViewBag.Monstertyp" required>
                        <option value="">Monstertyp auswählen...</option>
                    </select>
                </div>
            </div>
        </div>
        <!-- Basics Sektion -->
        <div class="monster-section mb-4">
            <div class="row align-items-start">
                <div class="col-lg-2">
                    <div class="toggle-container">
                        <div class="medieval-switch">
                            <input class="form-check-input" type="checkbox" id="meetSwitch" asp-for="meet" value="true">
                            <div class="switch-label">
                                <span class="switch-icon">⚔️</span>
                                <span class="switch-text">Begegnung<br /><small class="text-muted">Für Spieler aktivieren</small></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-10">
                    <label for="basics" class="form-label monster-label">
                        <span class="label-icon">📜</span> Basics
                    </label>
                    <small class="form-text text-muted d-block mb-2">
                        Diese Beschreibung wird angezeigt, wenn "Begegnung" aktiviert ist.
                    </small>
                    <div id="editor-wrapper">
                        <textarea class="form-control d-none" id="basics" name="basics">@(Model?.Basics ?? "")</textarea>
                        <div id="wysiwyg-editor"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Encounter Sektion -->
        <div class="monster-section mb-4">
            <div class="row align-items-start">
                <div class="col-lg-2">
                    <div class="toggle-container">
                        <div class="medieval-switch">
                            <input class="form-check-input" type="checkbox" id="encounterSwitch" asp-for="encounter" value="true">
                            <div class="switch-label">
                                <span class="switch-icon">🎲</span>
                                <span class="switch-text">Encounter<br/><small class="text-muted">Für Spieler aktivieren</small></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-10">
                    <label for="description" class="form-label monster-label">
                        <span class="label-icon">📜</span> Beschreibung
                    </label>
                    <small class="form-text text-muted d-block mb-2">
                        Diese Beschreibung wird angezeigt, wenn "Encounter" aktiviert ist.
                    </small>
                    <div id="editor-wrapper">
                        <textarea class="form-control d-none" id="description" name="description">@(Model?.Description ?? "")</textarea>
                        <div id="wysiwyg-editor1"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Perfected Sektion -->
        <div class="monster-section mb-4">
            <div class="row align-items-start">
                <div class="col-lg-2">
                    <div class="toggle-container">
                        <div class="medieval-switch">
                            <input class="form-check-input" type="checkbox" id="perfectedSwitch" asp-for="perfected" value="true">
                            <div class="switch-label">
                                <span class="switch-icon">✨</span>
                                <span class="switch-text">Perfected<br/><small class="text-muted">Extra-Infos aktivieren</small></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-10">
                    <label for="processeddescription" class="form-label monster-label">
                        <span class="label-icon">📖</span> Extra-Informationen
                    </label>
                    <small class="form-text text-muted d-block mb-2">
                        Diese Informationen werden nur angezeigt, wenn "Encounter" UND "Perfected" aktiviert sind.
                    </small>
                    <div id="editor-wrapper">
                        <textarea class="form-control d-none" id="processeddescription" name="processeddescription">@(Model?.ProcessedDescription ?? "")</textarea>
                        <div id="wysiwyg-editor2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gekaufte Trophäe Sektion -->
        <div class="monster-section mb-4">
            <div class="row align-items-start">
                <div class="col-lg-2">
                    <div class="toggle-container">
                        <div class="medieval-switch">
                            <input class="form-check-input" type="checkbox" id="boughtTrophySwitch" asp-for="HasBoughtTrophy" value="true">
                            <div class="switch-label">
                                <span class="switch-icon">💰</span>
                                <span class="switch-text">Gekaufte<br/>Trophäe<br/><small class="text-muted">Guild hat gekauft</small></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-10">
                    <label for="baseEffect" class="form-label monster-label">
                        <span class="label-icon">✨</span> Effekt der gekauften Trophäe
                    </label>
                    <small class="form-text text-muted d-block mb-2">
                        Dieser Effekt wird angewendet, wenn die Trophäe gekauft wurde. Nur sichtbar wenn "Begegnung" aktiviert ist.
                    </small>
                    <textarea class="form-control" id="baseEffect" name="baseEffect" rows="3" maxlength="500" placeholder="z.B. +1 auf Verteidigung gegen diesen Monstertyp">@Model?.BaseEffect</textarea>
                    <small class="form-text text-muted">Maximal 500 Zeichen</small>
                </div>
            </div>
        </div>

        <!-- Erlegte Trophäe Sektion -->
        <div class="monster-section mb-4">
            <div class="row align-items-start">
                <div class="col-lg-2">
                    <div class="toggle-container">
                        <div class="medieval-switch">
                            <input class="form-check-input" type="checkbox" id="slainTrophySwitch" asp-for="HasSlainTrophy" value="true">
                            <div class="switch-label">
                                <span class="switch-icon">🏆</span>
                                <span class="switch-text">Erlegte<br/>Trophäe<br/><small class="text-muted">Guild hat erlegt</small></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-10">
                    <label for="slainEffect" class="form-label monster-label">
                        <span class="label-icon">⚔️</span> Effekt der erlegten Trophäe
                    </label>
                    <small class="form-text text-muted d-block mb-2">
                        Dieser Effekt wird angewendet, wenn das Monster besiegt wurde. Nur sichtbar wenn "Begegnung" aktiviert ist. (Stärker als der Kauf-Effekt!)
                    </small>
                    <textarea class="form-control" id="slainEffect" name="slainEffect" rows="3" maxlength="500" placeholder="z.B. +2 auf Angriff und Verteidigung gegen diesen Monstertyp">@Model?.SlainEffect</textarea>
                    <small class="form-text text-muted">Maximal 500 Zeichen</small>
                </div>
            </div>
        </div>

        <div class="text-center">
            <button type="submit" class="btn-wachs">Gebilligt</button>
        </div>
    </form>
</div>
@section Scripts {
    <script src="~/js/imagePreview.js"></script>
    <script src="~/js/wysiwyg-editor.js"></script>
    <script src="~/js/entity-mentions.js"></script>
    <script src="~/js/monster-toggle-validation.js"></script>
    <script>
        // Tooltips aktivieren
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        enableImageDragDrop('#monster-drop-zone', 'monsterzeichenUpload');

        $(document).ready(function() {
            // Erster WYSIWYG-Editor initialisieren
            const wikiEditor = new WikiWYSIWYGEditor('#basics', '#wysiwyg-editor');

            // EntityMentions für ersten Editor
            setTimeout(() => {
                new EntityMentions('#basics');
            }, 800);

            // Zweiter WYSIWYG-Editor initialisieren
            const wikiEditordes = new WikiWYSIWYGEditor('#description', '#wysiwyg-editor1');

            // EntityMentions für zweiten Editor
            setTimeout(() => {
                new EntityMentions('#description');
            }, 800);

            // Dritter WYSIWYG-Editor initialisieren
            const wikiEditorpro = new WikiWYSIWYGEditor('#processeddescription', '#wysiwyg-editor2');

            // EntityMentions für dritten Editor
            setTimeout(() => {
                new EntityMentions('#processeddescription');
            }, 800);

            // Toggle-Validierung mit wiederverwendbarer Klasse
            const toggleValidator = new MonsterToggleValidator(
                '#meetSwitch',
                '#encounterSwitch',
                '#perfectedSwitch',
                '#boughtTrophySwitch',
                '#slainTrophySwitch'
            );

            // Form-Validierung vor dem Absenden
            $('form').on('submit', function(e) {
                if (!toggleValidator.validateForSubmit()) {
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
}