@model Suendenbock_App.Models.ViewModels.TicketsPageViewModel
@{
    ViewData["Title"] = "Beschwerdetafel";
}

@section Styles {
    <link rel="stylesheet" href="~/css/tickets.css" />
}

<div class="tickets-container">
    <!-- Header Section -->
    <div class="tickets-header">
        <div class="header-content">
            <a asp-action="Index" class="back-link">
                <span class="material-symbols-outlined">arrow_back</span>
                <span>Zurück zur Halle</span>
            </a>
            <h1 class="page-title">Beschwerdetafel</h1>
            <p class="page-subtitle">Melde Probleme, Fehler oder Verbesserungsvorschläge.</p>
        </div>

        <button class="btn-primary" id="createTicketBtn">
            <span class="material-symbols-outlined">add</span>
            Neues Ticket erstellen
        </button>
    </div>

    <!-- Filter Tabs -->
    <div class="tickets-tabs">
        <button class="ticket-tab active" data-status="all">
            Alle <span class="tab-count">@Model.Tickets.Count</span>
        </button>
        <button class="ticket-tab" data-status="Pending">
            Offen <span class="tab-count">@Model.Tickets.Count(t => t.Status == "Pending")</span>
        </button>
        <button class="ticket-tab" data-status="Resolved">
            Gelöst <span class="tab-count">@Model.Tickets.Count(t => t.Status == "Resolved")</span>
        </button>
    </div>

    <!-- Tickets Grid -->
    <div class="tickets-grid">
        @if (!Model.Tickets.Any())
        {
            <div class="empty-state">
                <span class="material-symbols-outlined">inbox</span>
                <p>Noch keine Tickets vorhanden.</p>
            </div>
        }
        else
        {
            @foreach (var ticket in Model.Tickets)
            {
                <div class="ticket-card @(ticket.Status == "Resolved" ? "resolved" : "pending")"
                     data-ticket-id="@ticket.Id"
                     data-status="@ticket.Status">
                    <div class="ticket-header">
                        <div class="ticket-meta">
                            <span class="ticket-status @(ticket.Status == "Pending" ? "pending" : "resolved")">
                                <span class="material-symbols-outlined">
                                    @(ticket.Status == "Pending" ? "pending" : "check_circle")
                                </span>
                                @(ticket.Status == "Pending" ? "Offen" : "Gelöst")
                            </span>
                            <span class="ticket-category">@ticket.Category</span>
                            <span class="ticket-id">#@ticket.Id</span>
                        </div>

                        @if (ticket.CanEdit)
                        {
                            <div class="ticket-admin-actions">
                                @if (ticket.Status == "Pending")
                                {
                                    <button class="admin-action-btn resolve-ticket-btn"
                                            data-ticket-id="@ticket.Id"
                                            title="Als gelöst markieren">
                                        <span class="material-symbols-outlined">done</span>
                                    </button>
                                }
                                else
                                {
                                    <button class="admin-action-btn reopen-ticket-btn"
                                            data-ticket-id="@ticket.Id"
                                            title="Wieder öffnen">
                                        <span class="material-symbols-outlined">refresh</span>
                                    </button>
                                }
                                <button class="admin-action-btn edit-ticket-btn"
                                        data-ticket-id="@ticket.Id"
                                        title="Ticket bearbeiten">
                                    <span class="material-symbols-outlined">edit</span>
                                </button>
                                <button class="admin-action-btn delete-ticket-btn"
                                        data-ticket-id="@ticket.Id"
                                        title="Ticket löschen">
                                    <span class="material-symbols-outlined">delete</span>
                                </button>
                            </div>
                        }
                    </div>

                    <h2 class="ticket-title">@ticket.Title</h2>
                    <p class="ticket-description">@ticket.Description</p>

                    <div class="ticket-footer">
                        <div class="ticket-reporter">
                            <span class="material-symbols-outlined">person</span>
                            <span>@ticket.ReporterName</span>
                        </div>
                        <div class="ticket-date">
                            <span class="material-symbols-outlined">schedule</span>
                            <span>@ticket.CreatedAt</span>
                        </div>
                        @if (!string.IsNullOrEmpty(ticket.ResolvedAt))
                        {
                            <div class="ticket-resolved-info">
                                <span class="material-symbols-outlined">done_all</span>
                                <span>Gelöst am @ticket.ResolvedAt von @ticket.ResolvedByName</span>
                            </div>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>

<!-- Create Ticket Modal -->
<div id="createTicketModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Neues Ticket erstellen</h3>
            <button class="modal-close" onclick="closeCreateTicketModal()">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <form id="createTicketForm" class="modal-body">
            <div class="form-group">
                <label for="ticketTitle">Titel *</label>
                <input type="text" id="ticketTitle" name="title" required
                       placeholder="Kurze Beschreibung des Problems">
            </div>

            <div class="form-group">
                <label for="ticketCategory">Kategorie *</label>
                <select id="ticketCategory" name="category" required>
                    <option value="Bug">Bug / Fehler</option>
                    <option value="Support">Support / Hilfe</option>
                    <option value="Suggestion">Vorschlag / Idee</option>
                    <option value="Other">Sonstiges</option>
                </select>
            </div>

            <div class="form-group">
                <label for="ticketDescription">Beschreibung *</label>
                <textarea id="ticketDescription" name="description" rows="5" required
                          placeholder="Detaillierte Beschreibung..."></textarea>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCreateTicketModal()">
                    Abbrechen
                </button>
                <button type="submit" class="btn-primary">
                    <span class="material-symbols-outlined">send</span>
                    Ticket einreichen
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Ticket Modal -->
<div id="editTicketModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Ticket bearbeiten</h3>
            <button class="modal-close" onclick="closeEditTicketModal()">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <form id="editTicketForm" class="modal-body">
            <input type="hidden" id="editTicketId">

            <div class="form-group">
                <label for="editTicketTitle">Titel *</label>
                <input type="text" id="editTicketTitle" name="title" required>
            </div>

            <div class="form-group">
                <label for="editTicketCategory">Kategorie *</label>
                <select id="editTicketCategory" name="category" required>
                    <option value="Bug">Bug / Fehler</option>
                    <option value="Support">Support / Hilfe</option>
                    <option value="Suggestion">Vorschlag / Idee</option>
                    <option value="Other">Sonstiges</option>
                </select>
            </div>

            <div class="form-group">
                <label for="editTicketDescription">Beschreibung *</label>
                <textarea id="editTicketDescription" name="description" rows="5" required></textarea>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeEditTicketModal()">
                    Abbrechen
                </button>
                <button type="submit" class="btn-primary">
                    <span class="material-symbols-outlined">save</span>
                    Speichern
                </button>
            </div>
        </form>
    </div>
</div>

@section Styles {
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
}

@section Scripts {
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/js/tickets.js"></script>
}
